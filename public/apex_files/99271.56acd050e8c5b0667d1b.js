"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[99271],{150112:(e,t,i)=>{i.d(t,{createDwmAligner:()=>l,createTimeToBarTimeAligner:()=>d});var s=i(276536),n=i(257253),r=i(89523),o=i(313503);const a=new r.SessionInfo("Etc/UTC","0000-0000:1234567");function l(e,t,i){if(!e||!n.Interval.isDWM(t))return null;const l=new r.SessionInfo(i.timezone,i.session,i.session_holidays,i.corrections),d=(0,o.newBarBuilder)(t,l,a);return{timeToSessionStart:e=>d.tradingDayToSessionStart(e),timeToExchangeTradingDay:e=>{const t=(0,s.utc_to_cal)(l.timezone,e),i=l.spec.correctTradingDay(t);return(0,s.set_hms)(i,0,0,0,0,(0,s.get_timezone)("Etc/UTC")),i.getTime()}}}function d(e,t,i){if(!e)return e=>e;const s=new r.SessionInfo(i.timezone,i.session,i.session_holidays,i.corrections),n=(0,o.newBarBuilder)(t,s,s,!1);return e=>n.alignTimeIfPossible(e)}},399285:(e,t,i)=>{i.d(t,{lineToolsDoNotAffectChartInvalidation:()=>s});const s=!0},186856:(e,t,i)=>{i.d(t,{LineDataSourcePointIndexProperty:()=>n});var s=i(751610);class n extends s.Property{constructor(e,t){super(),this._waitingPointsetUpdate=!1,this._lineSource=e,this._pointIndex=t,this._cachedIndex=this.value()}value(){const e=this._lineSource.points();return 0===e.length?this._cachedIndex:e[this._pointIndex].index}setValue(e){this._cachedIndex=e;const t=this._lineSource.points(),i=e=>{const t=this._lineSource.points()[this._pointIndex];if(t.index===e)return;t.index=e,this._lineSource.startChanging(this._pointIndex,t),this._setPointImpl(t),this._lineSource.model().updateSource(this._lineSource),this._listeners.fire(this,"");const i=this._lineSource.endChanging(!0,!1);this._lineSource.syncMultichartState(i)};if(0===t.length){const e=()=>{i(this._cachedIndex),this._waitingPointsetUpdate=!1};if(this._waitingPointsetUpdate)return;this._lineSource.pointsetUpdated().subscribe(this,e,!0),this._waitingPointsetUpdate=!0}else i(e)}_setPointImpl(e){this._lineSource.setPoint(this._pointIndex,e)}}},377964:(e,t,i)=>{i.d(t,{LineToolPriceAxisView:()=>o});var s=i(650151),n=i(207925),r=i(650369);class o extends n.PriceAxisView{constructor(e,t){super(),this._source=e,this._data=t,this._properties=e.model().properties().childs().scalesProperties}_updateRendererData(e,t,i){e.visible=!1;const s=this._source.model();if(s.timeScale().isEmpty())return;const n=this._source.priceScale();if(null===n||n.isEmpty())return;if(!s.selection().isSelected(this._source)&&!this._source.isForcedDrawPriceAxisLabel())return;if(null===s.timeScale().visibleBarsStrictRange())return;const o=this._source.priceAxisPoints(),a=this._data.pointIndex;if(o.length<=a)return;const l=o[a];if(!isFinite(l.price))return;const d=this._source.ownerSource(),h=null!==d?d.firstValue():null;if(null===h)return;let u=this._data.backgroundPropertyGetter?this._data.backgroundPropertyGetter():null;null===u&&(u=this._getBgColor());let c=!0;const _=this._formatPrice(l.price,h);a>0&&(c=!o.slice(0,a).some((e=>this._formatPrice(e.price,h)===_))),u=(0,r.resetTransparency)(u),i.background=u,i.borderColor=u,
i.textColor=this.generateTextColor(i.background),i.coordinate=n.priceToCoordinate(l.price,h),e.text=_,e.visible=c,e.selectedMarkColor=s.selection().isSelected(this._source)?u:void 0}_getBgColor(){return this._active?this._properties.childs().axisLineToolLabelBackgroundColorActive.value():this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}_formatPrice(e,t){return(0,s.ensureNotNull)(this._source.priceScale()).formatPrice(e,t)}}},593412:(e,t,i)=>{i.d(t,{LineDataSourceTimeAxisView:()=>n});var s=i(108024);class n extends s.TimeAxisView{constructor(e,t){super(e.model()),this._active=!1,this._source=e,this._pointIndex=t,this._properties=e.model().properties().childs().scalesProperties}setActive(e){this._active=e}_getBgColor(){return this._active?this._properties.childs().axisLineToolLabelBackgroundColorActive.value():this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}_getIndex(){if(!this._model.selection().isSelected(this._source))return null;const e=this._source.timeAxisPoints();return e.length<=this._pointIndex?null:e[this._pointIndex].index}_isVisible(){return!0}}},23369:(e,t,i)=>{i.d(t,{LineDataSource:()=>q,changePointUndoText:()=>$});var s=i(378338),n=i(610555),r=i(650151),o=i(536794),a=i(251954),l=i(735566),d=i(687037),h=i(62056),u=i(196717),c=i(4944),_=i(251924),p=i(42437),g=i(395296),m=i(427060),S=i(648844),y=i(984958),v=i(308950),P=i(77294),f=i(728587),b=i(231504),A=i(507083),w=i(841528),C=i(104779),T=i(569322),I=i(666310),x=i(751610),V=i(313344),D=i(222874),L=i(61689),M=i(830842),E=i(27681),F=i(892323),U=i(186856);class k extends x.Property{constructor(e,t){super(),this._lineSource=e,this._pointIndex=t,e.pointAdded().subscribe(this,(e=>{this._pointIndex===e&&this._listeners.fire(this,`${e}`)})),e.pointChanged().subscribe(this,(e=>{this._pointIndex===e&&this._listeners.fire(this,`${e}`)}))}value(){const e=this._lineSource.points()[this._pointIndex].price,t=(0,r.ensureNotNull)(this._lineSource.ownerSource()).formatter();if(t.parse){const i=t.format(e),s=t.parse(i);return s.res?s.value:e}return e}setValue(e){const t=this._lineSource.points()[this._pointIndex];t.price=parseFloat(""+e),this._lineSource.startChanging(this._pointIndex,t),this._lineSource.setPoint(this._pointIndex,t),this._lineSource.model().updateSource(this._lineSource),this._listeners.fire(this,"");const i=this._lineSource.endChanging(!0,!1);this._lineSource.syncMultichartState(i)}}var N=i(593412),z=i(377964),O=i(478481),R=i(825079),B=i(453287),H=i(74037);const W=(0,l.getLogger)("Chart.LineDataSource"),G=d.enabled("datasource_copypaste");class j{constructor(){this._states=[]}start(e){this._states.push(e)}finish(e){const t=(0,r.ensureDefined)(this._states.pop());return s=t,(i=e).length!==s.length?{indexesChanged:!0,pricesChanged:!0}:i.reduce(((e,t,i)=>{const n=s[i];return e.indexesChanged=e.indexesChanged||t.index!==n.index,e.pricesChanged=e.pricesChanged||t.price!==n.price,e}),{indexesChanged:!1,pricesChanged:!1});var i,s}isEmpty(){return 0===this._states.length}}let K=0
;const $=new F.TranslatedString("change point",s.t(null,void 0,i(776660)));class q extends D.DataSource{constructor(e,t,i,s){if(super(s),this.isLineTool=!0,this.version=1,this.toolname="",this.customization={forcePriceAxisLabel:!1,disableErasing:!1,disableSave:!1,showInObjectsTree:!0},this._currentPointsetAndSymbolId=null,this._pointChanged=new _.Delegate,this._pointAdded=new _.Delegate,this._priceAxisViews=[],this._timeAxisViews=[],this._timePoint=[],this._points=[],this._lastPoint=null,this._paneViews=new Map,this._signaturesPaneViews=new Map,this._normalizedPointsChanged=new _.Delegate,this._fixedPointsChanged=new _.Delegate,this._changeStatesStack=new j,this._startMovingPoint=null,this._currentMovingPoint=null,this._isActualSymbol=!1,this._isActualInterval=!1,this._isActualCurrency=!1,this._isActualUnit=!1,this._symbolSource=null,this._symbolSourceSymbolInfo=null,this._sharingMode=new P.WatchedValue(0),this._onTemplateApplying=new _.Delegate,this._onTemplateApplied=new _.Delegate,this._syncStateExclusions=["interval"],this._definitionsViewModel=null,this._hasEditableCoordinates=new P.WatchedValue(!0),this._syncLineStyleMuted=!1,this._onIsActualIntervalChange=new _.Delegate,this._onIsActualSymbolChange=new _.Delegate,this._onPointsetUpdatedDelegate=new _.Delegate,this._onServerUpdateTime=new _.Delegate,this._linkKey=new P.WatchedValue(null),this._serverUpdateTime=null,this._boundCalcIsActualSymbol=this.calcIsActualSymbol.bind(this),this._alignerCache=null,this._alertUndoMode=!1,this._targetSignature=new P.WatchedValue(null),this._firstSignatureOwnerSource=null,this._sourcesSignatures=null,this._onAlertStatusChanged=()=>{this.updateAllViewsAndRedraw((0,M.sourceChangeEvent)(this.id()))},this._model=e,this._properties=t,this._localAndServerAlertsMismatch=!1,this._properties.hasChild("interval")||this._properties.addChild("interval",new x.Property(e.mainSeries().interval())),this.calcIsActualSymbol(),this._properties.childs().intervalsVisibilities.subscribe(this,this.calcIsActualSymbol),this._properties.subscribe(this,this.propertiesChanged.bind(this,!1,void 0)),this.zOrderChanged().subscribe(this,this.propertiesChanged.bind(this,!0,void 0)),this._createPointsProperties(),this.pointsCount()>0)for(let e=0;e<this.pointsCount();e++)this._priceAxisViews.push(this.createPriceAxisView(e)),this._timeAxisViews.push(new N.LineDataSourceTimeAxisView(this,e));this._properties.childs().visible.subscribe(this,(e=>{const t=!1===(0,V.hideAllDrawings)().value();e.value()?e.value()&&t&&a.emit("drawing_event",this._id.value(),"show"):(this._model.selection().isSelected(this)&&this._model.selectionMacro((e=>{e.removeSourceFromSelection(this)})),t&&a.emit("drawing_event",this._id.value(),"hide")),this._onSourceHiddenMayChange()})),(0,V.hideAllDrawings)().subscribe(this,this._onSourceHiddenMayChange),this._sessionConnected=this._model.chartApi().isConnected().spawn(),this._sessionConnected.subscribe((e=>{e||(this._currentPointsetAndSymbolId=null)})),this._alertStatus.subscribe(this._onAlertStatusChanged),this._definitionsViewModel=null,
this._properties.setNameInOwner((0,H.propertyPathForSource)(this)),i||this._updateAdjustedToSplitTimeValue(!0),this._sourcesSignatures=e.sourcesSignatures().spawn(),this._sourcesSignatures.subscribe(this._updateSignaturesPaneViews.bind(this)),this._targetSignature.subscribe(this._updateSignaturesPaneViews.bind(this)),this.supportsTargetSignature()&&(this._firstSignatureOwnerSource=(0,c.combine)(((e,t)=>t.find((t=>t.signature().value()===e))??null),this._targetSignature.weakReference(),e.signatureSources().weakReference()),this._firstSignatureOwnerSource.subscribe((e=>{this.setOwnerSource(e),e&&this._model.realignLineTools(e.symbolSource())})))}destroy(){this._paneViews.forEach(((e,t)=>this._destroyPanePaneViews(t))),this.stop(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),null!==this._ownerSource&&(this._ownerSource.currencyChanged().unsubscribeAll(this),this._ownerSource.unitChanged().unsubscribeAll(this),(0,E.isSymbolSource)(this._ownerSource)&&(this._ownerSource.symbolResolved().unsubscribeAll(this),this._ownerSource.isActingAsSymbolSource().unsubscribe(this._boundCalcIsActualSymbol))),this.ownerSourceChanged().unsubscribeAll(this),this._symbolSource?.destroy(),this._symbolSourceSymbolInfo?.destroy(),(0,V.hideAllDrawings)().unsubscribeAll(this),this.deleteAlert(),this._sessionConnected.destroy(),this._alertStatus.unsubscribe(this._onAlertStatusChanged),this._properties.destroy(),this._sourcesSignatures?.destroy(),this._firstSignatureOwnerSource?.destroy(),super.destroy()}setId(e){super.setId(e),this._properties.setNameInOwner((0,H.propertyPathForSource)(this))}priceScale(){return this._ownerSource?this._ownerSource.priceScale():null}createPriceAxisView(e){return new z.LineToolPriceAxisView(this,{pointIndex:e})}model(){return this._model}symbol(){return this._properties.childs().symbol.value()}linkKey(){return this._linkKey}serverUpdateTime(){return this._serverUpdateTime}setServerUpdateTime(e){this._serverUpdateTime=e,this._onServerUpdateTime.fire()}serverUpdateTimeChanged(){return this._onServerUpdateTime}adjustedToSplitTime(){let e=this._properties.childs().adjustedToSplitTime.value();return null===e&&null!==this._serverUpdateTime&&(e=this._serverUpdateTime/1e3),e}adjustToSplit(e,t){for(const t of this._points)t.price*=e;for(const t of this._timePoint)t.price*=e;this._points.forEach(((e,t)=>{this._pointChanged.fire(t)})),this._properties.childs().adjustedToSplitTime.setValue(t);const i=this.linkKey().value();null!==i&&this.isSynchronizable()&&(0,V.restoreLineToolState)({model:this._model,linkKey:i,state:this.state()})}boundToSymbol(){return!0}isAvailableInFloatingWidget(){return!0}points(){const e=[];for(let t=0;t<this._points.length;t++){const i=this._points[t];e.push({index:i.index,price:i.price,time:i.time})}return this._lastPoint&&e.push(this._correctLastPoint(this._lastPoint)),!this.isFixed()&&this._currentMovingPoint&&this._startMovingPoint&&this._correctPoints(e),e}timeAxisPoints(){return this.points()}priceAxisPoints(){return this.points()}
fixedPoint(e){if(!this.isFixed())return;let t;const i=e?e.priceScale():this.priceScale();if(this._positionPercents&&null!==i&&!i.isEmpty()){const e=this._positionPercents,s=this._model.timeScale().width()*e.x,r=i.height()*e.y;t=new n.Point(s,r)}else void 0!==this._fixedPoint&&(t=this._fixedPoint?.clone());if(this._currentMovingPoint&&this._startMovingPoint&&void 0!==t){const e=this._correctFixedPoint(t);e.didCorrect&&(t=e.point)}return t}positionPercents(){return this.isFixed()?this._positionPercents:void 0}clearFixedPoint(){this._fixedPoint=void 0,this._positionPercents=void 0}normalizedPoints(){return this._timePoint}normalizedPointsForCreating(){return this.normalizedPoints()}normalizedPointsChanged(){return this._normalizedPointsChanged}fixedPointChanged(){return this._fixedPointsChanged}geometry(){const e=(0,r.ensureNotNull)(this.priceScale());return this.points().map((t=>{const i=(0,r.ensureNotNull)(this.pointToScreenPoint(t)),s=i.x/this._model.timeScale().width(),o=i.y/e.height();return new n.Point(s,o)}))}widthsProperty(){return this._properties.childs().linesWidths??null}lineColorsProperty(){return this._properties.childs().linesColors??null}backgroundColorsProperty(){return this._properties.childs().backgroundsColors??null}textColorsProperty(){return this._properties.childs().textsColors??null}pointsProperty(){return this._pointsProperty}hasEditableCoordinates(){return this._hasEditableCoordinates}startMoving(e,t,i,s){this.isFixed()&&this.restoreFixedPoint(),this._startMovingPoint=e}move(e,t,i,s){if(i&&(i.shiftOnly()||i.modShift()))if(this.isFixed()){const t=this._alignScreenPointHorizontallyOrVertically((0,r.ensureDefined)(e.screen));this._currentMovingPoint={screen:t}}else{const t=this._alignPointHorizontallyOrVertically((0,r.ensureDefined)(e.logical)),i=(0,r.ensureNotNull)(this.pointToScreenPoint(t));this._currentMovingPoint={logical:t,screen:i}}else this._currentMovingPoint=e;this.updateAllViews((0,M.sourceChangeEvent)(this.id()))}endMoving(e,t,i){let s=!1,n=!1;if(this._currentMovingPoint&&this._startMovingPoint){if(this.isFixed()){const e=this._correctFixedPoint((0,r.ensureDefined)(this._fixedPoint));e.didCorrect&&(this._fixedPoint=e.point,this._fixedPointsChanged.fire())}else{const e=(0,r.ensureDefined)(this._currentMovingPoint.logical),t=(0,r.ensureDefined)(this._startMovingPoint.logical);s=e.index!==t.index,n=e.price!==t.price;if(this._correctPoints(this._points,i)){const e=this._id.value();a.emit("drawing_event",e,"move"),a.emit("drawing_event",e,"points_changed"),this._updateAdjustedToSplitTimeValue();for(let e=0;e<this._points.length;e++)this._pointChanged.fire(e)}}this._startMovingPoint=null,this._currentMovingPoint=null}const o={indexesChanged:s,pricesChanged:n};return this.isFixed()?(this.calcPositionPercents(),this.updateAllViews((0,M.sourceChangeEvent)(this.id())),o):(s&&this._points.forEach((e=>e.interval=this._model.mainSeries().interval())),this.updateAllViews((0,M.sourceChangeEvent)(this.id())),s&&!e?(this._properties.childs().interval.setValue(this._model.mainSeries().interval()),
this._normalizePoints(),this.createServerPoints()):(this._copyPricesWithoutNormalization(),this._normalizedPointsChanged.fire()),t||!n&&!s||this.synchronizeAlert(!this._alertUndoMode),o)}startMovingPoint(){return this._startMovingPoint?{...this._startMovingPoint}:null}currentMovingPoint(){return this._currentMovingPoint?{...this._currentMovingPoint}:null}changePointUndoText(e){return $}startChanging(e,t){this.isFixed()&&this.restoreFixedPoint(),void 0!==e&&void 0!==t&&(e<this._priceAxisViews.length&&this._priceAxisViews[e].setActive(!0),e<this._timeAxisViews.length&&this._timeAxisViews[e].setActive(!0)),this._changeStatesStack.start(this.points())}endChanging(e,t,i){const s=this._changeStatesStack.finish(this.points());s.indexesChanged&&this._changeStatesStack.isEmpty()?(this._normalizePoints(),t||this.createServerPoints()):(this._copyPricesWithoutNormalization(),this._normalizedPointsChanged.fire()),a.emit("drawing_event",this._id.value(),"points_changed"),this._updateAdjustedToSplitTimeValue();for(let e=0;e<this._priceAxisViews.length;e++)this._priceAxisViews[e].setActive(!1);for(let e=0;e<this._timeAxisViews.length;e++)this._timeAxisViews[e].setActive(!1);return i||this.synchronizeAlert(!e),s}setPoint(e,t,i,s){if(this._snapTo45DegreesApplicable(i)){const i=0===e?1:e-1;this.snapPoint45Degree(t,this.points()[i])}this._setPoint(e,{...t,interval:this._model.mainSeries().interval()})}getPoint(e){return this.points()[e]||null}alignCrossHairToAnchor(e){return!0}alignCrossHairToMovePoint(){return!1}setLastPoint(e,t,i=!0){return this._lastPoint=i?this._preparePoint(e,t):e,this.updateAllViews((0,M.sourceChangeEvent)(this.id())),this._lastPoint}lastPoint(){return this._lastPoint}getChangePointForSync(e){return this.getPoint(e)}setPoints(e){const t=this._model.mainSeries().interval();this._points=e.map((e=>({...e,interval:e.interval??t})))}isForcedDrawPriceAxisLabel(){return this.customization.forcePriceAxisLabel}clearData(){this._points=[]}denormalizeTimePoints(){let e=[];const t=this._model.mainSeries().interval();for(let i=0;i<this._timePoint.length;i++){const s=this._model.timeScale().denormalizeTimePoint(this._timePoint[i]);if(void 0===s){e=[];break}e.push({index:s,price:this._timePoint[i].price,interval:this._timePoint[i].interval??t})}e.length>0&&(this._points=e)}restorePoints(e,t,i){const s=this._timePoint.length>0&&!(0,o.deepEquals)(this._timePoint,e)[0],n=this._properties.childs().interval.value();this._timePoint=e.map((e=>({...e,interval:e.interval??n})));const r=this._model.mainSeries().interval();this._points=t.map((e=>({...e,interval:r}))),i||this.denormalizeTimePoints(),s&&this._normalizedPointsChanged.fire()}restorePositionPercents(e){this._positionPercents=e,this.restoreFixedPoint()}calcIsActualSymbol(){const e=this.ownerSource(),t=this._isActualSymbol;if(null===e)this._isActualSymbol=!1;else{const e=this._symbolSource?.value(),t=this._symbolSourceSymbolInfo?.value();if(t&&e){this._migrateSymbolProperty(t);const i=this._properties.childs().symbol,s=i.value();if(this._isActualSymbol=e.symbolSameAsCurrent(s),
this._isActualSymbol){const n=(0,C.extractLineToolSymbolFromSymbolInfo)(t,e.symbol());(0,T.areEqualSymbols)(s,n)||(W.logWarn('Possible drawing "migrating" detected from "'+s+'" to "'+n+'"'),W.logWarn("Series symbolInfo: "+JSON.stringify(e.symbolInfo())),W.logWarn(`${(new Error).stack}`)),i.setValue(n)}}}this._isActualSymbol!==t&&this._onIsActualSymbolChange.fire(),this.calcIsActualInterval(),this.calcIsActualCurrency(),this.calcIsActualUnit(),this._onSourceHiddenMayChange()}calcIsActualCurrency(){const e=this.ownerSource();if(null===e)return void(this._isActualCurrency=!1);let t=this._properties.childs().currencyId.value();if(null!==t){const i=e.symbolSource();"pct"===t&&(this._properties.childs().currencyId.setValue(null),t=null),this._isActualCurrency=t===(0,C.symbolCurrency)(i.symbolInfo(),void 0,!0)}else{const t=(0,r.ensureNotNull)(e.symbolSource());this._isActualCurrency=null!==t.symbolInfo()&&!t.isConvertedToOtherCurrency()}this._onSourceHiddenMayChange()}calcIsActualUnit(){const e=this.ownerSource();if(null===e)return void(this._isActualUnit=!1);const t=this._properties.childs().unitId.value();if(null!==t)this._isActualUnit=t===(0,r.ensureNotNull)(e.symbolSource()).unit();else{const t=(0,r.ensureNotNull)(e.symbolSource());this._isActualUnit=null!==t.symbolInfo()&&!t.isConvertedToOtherUnit()}this._onSourceHiddenMayChange()}calcIsActualInterval(){const e=this._isActualInterval,t=this._properties,i=this._model.mainSeries();this._isActualInterval=(0,A.isActualInterval)(I.Interval.parse(i.interval()),t.childs().intervalsVisibilities),!this._isActualInterval&&this._model.selection().isSelected(this)&&this._model.selectionMacro((e=>e.removeSourceFromSelection(this))),this._isActualInterval!==e&&this._onIsActualIntervalChange.fire(),this._onSourceHiddenMayChange()}paneViews(e){if(this.isSourceHidden())return null;const t=this._getPaneViews(this.isMultiPaneAvailable()?e:void 0);if(null===t)return null;if(1===t.length)return[t[0]];const i=[];for(let e=t.length-1;e>=0;--e)i.push(t[e]);return i}priceAxisViews(e,t){if(this.isFixed())return null;if(t!==this.priceScale()||this.isSourceHidden())return null;if(this._model.lineBeingEdited()===this){const e=this._model.linePointBeingEdited();if(null!==e&&e<this._priceAxisViews.length){const t=this._priceAxisViews.slice(),i=t[e];return t.splice(e,1),t.push(i),t}return this._priceAxisViews}return this._priceAxisViews}timeAxisViews(){if(this.isSourceHidden()||this.isFixed())return null;if(this._model.lineBeingEdited()===this){const e=this._model.linePointBeingEdited();if(null!==e&&e<this._timeAxisViews.length){const t=this._timeAxisViews.slice(),i=t[e];return t.splice(e,1),t.push(i),t}return this._timeAxisViews}return this._timeAxisViews}isSavedInChart(){return!this.customization.disableSave}isSavedInStudyTemplates(){return!1}setSavingInChartEnabled(e){this.customization.disableSave=!e}shouldBeRemovedOnDeselect(){return!1}getOrderTemplate(){return null}getSourceIcon(){return{type:"loadSvg",svgId:"linetool."+this.toolname}}alertId(){return this._alertId}async waitSettingAlertId(){
this._pendingAlertIdPromise&&(this._alertId=await this._pendingAlertIdPromise)}async setAlert(e,t={}){if(!this.canHasAlert())throw new Error("Line data source can not has alert");if(this._pendingAlertIdPromise)return void W.logWarn("Setting alert of line data source will be ignored because alert is already being set");if((0,o.isPromise)(e)){this._pendingAlertIdPromise=e;try{await this.waitSettingAlertId()}finally{delete this._pendingAlertIdPromise}}else this._alertId=e;const i=(0,r.ensureDefined)(this._alertId);this._hasAlert.setValue(!0),this._alertStatus.setValue(1),this._removeAlertSubscriptions(),await this._syncAlertWithAlertFacade(t);const s=this.linkKey().value();s&&!t.sync&&this._syncLineStyleChanges(s,{},i)}async restoreAlert(e,t){if(!this.canHasAlert())throw new Error("Line data source can not has alert");this._alertId=e,this._hasAlert.setValue(!0);try{const e=await this.getAlert();if(!e)return;this._addAlertSubscriptions(e,t)}catch(e){this._removeAlertSubscriptions()}}editAlert(e){this.hasAlert().value()&&(0,g.getChartAlertsFacade)().then((t=>{t.openEditDialog((0,r.ensureDefined)(this._alertId),{dataSourceHub:this._model,actionSource:e,onAborted:e=>{e===v.AlertEditorAbortReason.AlertIsInvalid&&this.removeAlert()}})}))}async getAlert(){try{const e=await this._getChartAlert();if(!e)throw W.logError("Failed to get alert, alert will not be saved with drawing in chart"),new Error("got_no_alert");return e}catch(e){if(e instanceof Error&&"not implemented"===e.message)throw e;if("not_exists"===e)throw new Error(e);return W.logError(`Getting alert failed: ${e instanceof Error?e.message:e}`),null}}getAlertSync(){if(!this._alertId)return null;const e=(0,g.getChartAlertsFacadeIfCreatedBefore)();return null===e?null:e.getAlertSync(this._alertId)??null}async synchronizeAlert(e=!1){if(this.hasAlert().value()||this._pendingAlertIdPromise)return new Promise(((t,i)=>{setTimeout((async()=>{if(!this._isDestroyed)try{await this.waitSettingAlertId(),0===this._alertStatus.value()&&await this._syncAlertWithAlertFacade(),this.hasAlert().value()&&await this._synchronizeAlert(e),t()}catch(e){i(e)}}),0)}))}syncAlert(e){this.hasAlert().value()||this.setAlert(e,{sync:!0})}stateForAlert(){if(!this.canHasAlert())return null;const e=this.state();let t={points:e.points,state:e.state,type:e.type,id:this.idForAlert(),title:this.translatedType(),interval:this._model.mainSeries().interval(),text:(this._properties.childs().text?.value()??this._properties.childs().labelText?.value())||void 0};const i=this._getAlertPlots();return i&&i.length>0&&(t={...t,plots:i}),t}async stateForAlertAsync(){return this.canHasAlert()?(this._points.length||(this.isStarted()||this.createServerPoints(),await this._awaitForPointset()),this.stateForAlert()):null}getAlertIsActive(){if(!this._alertId)return!1;const e=this.getAlertSync();return Boolean(e&&e.active().value())}detachAlert(){this._removeAlertSubscriptions(),this._hasAlert.setValue(!1),this._alertId=void 0,this._alertStatus.setValue(0)}removeAlert(){this._alertId=void 0,this._hasAlert.setValue(!1),
this._alertStatus.setValue(0),this._removeAlertSubscriptions()}deleteAlert(){if(!this.hasAlert().value()||void 0===this._alertId)return;const e=(0,g.getChartAlertsFacadeIfCreatedBefore)();e&&e.deleteAlert(this._alertId),this.removeAlert()}areLocalAndServerAlertsMismatch(){return this._localAndServerAlertsMismatch}showInObjectTree(){return this.customization.showInObjectsTree}setShowInObjectsTreeEnabled(e){this.customization.showInObjectsTree=e}start(){this.createServerPoints()}processHibernate(){this.canBeHibernated()?this.isStarted()&&this.stop():this.isStarted()||this.start()}canBeHibernated(){return this.isSourceHidden()}onData(e){"pointset_error"!==e.method?e.params.customId===this._currentPointsetIdWithPrefix()&&this._onPointsetUpdated(e.params.plots):W.logError(`Error getting pointset: ${e.params[0]} ${e.params[1]}`)}isBeingEdited(){return this===this._model.lineBeingEdited()}isActualSymbol(){return this._isActualSymbol}isActualCurrency(){return this._isActualCurrency}isActualInterval(){return this._isActualInterval}isActualUnit(){return this._isActualUnit}onIsActualIntervalChange(){return this._onIsActualIntervalChange}onIsActualSymbolChange(){return this._onIsActualSymbolChange}setOwnerSource(e){if(null!==this._ownerSource&&(this._ownerSource.currencyChanged().unsubscribeAll(this),this._ownerSource.unitChanged().unsubscribeAll(this),this._symbolSource?.destroy(),this._symbolSource=null,this._symbolSourceSymbolInfo?.destroy(),this._symbolSourceSymbolInfo=null),super.setOwnerSource(e),e){this._symbolSource=e.symbolSourceWV().spawn();const t=(0,c.combine)((e=>[e.symbolInfoWV().weakReference()]),this._symbolSource.weakReference());this._symbolSourceSymbolInfo=(0,c.accumulate)((e=>e[0]??null),t.ownership()),this._symbolSourceSymbolInfo.subscribe(this._boundCalcIsActualSymbol),this.setPriceScale(e.priceScale()),e.currencyChanged().subscribe(this,this.calcIsActualCurrency),e.unitChanged().subscribe(this,this.calcIsActualUnit),this.calcIsActualSymbol(),this._migrateZOrder(),this._updateAlertCreationAvailable()}(0,E.isSymbolSource)(e)&&(e.symbolResolved().subscribe(this,this._boundCalcIsActualSymbol),e.isActingAsSymbolSource().subscribe(this._boundCalcIsActualSymbol))}dataAndViewsReady(){return this._paneViews.size>0}pointAdded(){return this._pointAdded}pointChanged(){return this._pointChanged}pointsetUpdated(){return this._onPointsetUpdatedDelegate}pointToScreenPoint(e,t){const i=this._model.timeScale(),s=t?t.priceScale():this.priceScale(),r=(t??this.ownerSource())?.firstValue();if(!s||s.isEmpty()||i.isEmpty()||null==r)return null;const o=i.indexToCoordinate(e.index),a=s.priceToCoordinate(e.price,r);return new n.Point(o,a)}screenPointToPoint(e,t,i){const s=i?i.priceScale():this.priceScale(),n=(i??this.ownerSource())?.firstValue();if(null==n||!isFinite(n)||null===s)return null;const r=this._model.timeScale(),o=t?r.coordinateToFloatIndex(e.x):r.coordinateToIndex(e.x);return{price:s.coordinateToPrice(e.y,n),index:o}}calcMiddlePoint(e,t){return new n.Point((e.x+t.x)/2,(e.y+t.y)/2)}addPoint(e,t,i){
const s=this._preparePoint(e,t);return this._addPointIntenal(s,t,i)}addFixedPoint(e){return this._fixedPoint=e,this.calcPositionPercents(),!0}calcPositionPercents(){const e=this.priceScale();if(!e||e.isEmpty()||void 0===this._fixedPoint)return;const t=this._fixedPoint.x/this._model.timeScale().width(),i=this._fixedPoint.y/e.height();return this._positionPercents={x:t,y:i},this._positionPercents}restoreFixedPoint(){this._fixedPoint=this.fixedPoint()}propertiesChanged(e,t){this.calcIsActualInterval(),this.updateAllViewsAndRedraw((0,M.sourceChangeEvent)(this.id())),t||this._syncLineStyleIfNeeded(e),e||void 0!==this._pendingPropertyChangedEvent||(this._pendingPropertyChangedEvent=setTimeout((()=>{this._pendingPropertyChangedEvent=void 0,a.emit("drawing_event",this._id.value(),"properties_changed")}),0))}state(e){const t=this.toolname,i=this.ownerSource(),s={type:t,id:this.id(),state:this.properties().state(this._propertiesStateExclusions()),points:(0,p.deepCopy)(this._timePoint),zorder:this.zorder(),ownerSource:i?.id()},n=this._targetSignature.value();return this.supportsTargetSignature()&&n&&(s.targetSignature=n),this.linkKey().value()&&(s.linkKey=this.linkKey().value()),0!==this._sharingMode.value()&&(s.sharingMode=this._sharingMode.value()),delete s.state.points,e&&(s.indexes=this._points),this.isFixed()&&(s.positionPercents=this._positionPercents||this.calcPositionPercents()),"version"in this&&1!==this.version&&(s.version=this.version),this._saveAlertIdInState()&&this.hasAlert().value()&&void 0!==this._alertId&&(s.alertId=this._alertId),s}updateAllViews(e){this.isSourceHidden()||"data-source-change"===e.type&&this._ignoreSourceEvent(e)||(this._updateAllPaneViews(e),this._priceAxisViews.forEach((t=>t.update(e))),this._timeAxisViews.forEach((t=>t.update(e))))}updateAllViewsAndRedraw(e){this.updateAllViews(e),this._model.updateSource(this)}tags(){return[this.toolname]}properties(){return this._properties}restoreExternalPoints(e,t){try{if(this._timePoint=(0,p.deepCopy)(e.points),t.indexesChanged){if(this.properties().childs().interval.setValue(e.interval),!this.isActualSymbol())return void this._clearServerPoints();this.createServerPoints()}else{const t=Math.min(this._points.length,e.points.length);for(let i=0;i<t;i++)this._points[i].price=e.points[i].price}this.updateAllViewsAndRedraw((0,M.sourceChangeEvent)(this.id()))}finally{this._normalizedPointsChanged.fire()}}restoreExternalState(e){this.properties().mergeAndFire(e)}applyTemplate(e){this._onTemplateApplying.fire(e),this._applyTemplateImpl(e),this.calcIsActualSymbol(),this.updateAllViews((0,M.sourceChangeEvent)(this.id())),this.model().lightUpdate(),this._onTemplateApplied.fire()}template(){return this.properties().preferences()}isFixed(){return!1}anchorable(){return!1}isLocked(){const e=this.properties().child("frozen");return void 0!==e&&e.value()}isSourceHidden(){return!this._properties.childs().visible.value()||(0,V.hideAllDrawings)().value()&&this.canBeHidden()||!this._isActualInterval||!this._isActualSymbol||!this._isActualCurrency||!this._isActualUnit}
isSynchronizable(){return this.ownerSource()===this._model.mainSeries()}copiable(){return G}cloneable(){return null!==this._ownerSource&&null!==this._ownerSource.firstValue()}movable(){return!0}allowsMovingBetweenPanes(){return!1}async getPropertyDefinitionsViewModel(){if(null===this._definitionsViewModel){const e=await this._getPropertyDefinitionsViewModelClass();return null===e||this._isDestroyed?null:(this._definitionsViewModel=new e(this._model.undoModel(),this),this._definitionsViewModel)}return this._definitionsViewModel}title(){return this.translatedType()}translatedType(){return R.lineToolsLocalizedNames[this.toolname]??"Line Tool"}name(){return"Line Tool"}createServerPoints(){if(!this._isActualSymbol)return;if(!this._model.chartApi().isConnected().value())return;if(this._clearServerPoints(),this._model.timeScale().isEmpty())return;if(0===this._timePoint.length&&this._points.length>0&&this._normalizePoints(),!this._readyToCreatePointset())return;const e=this._pointsForPointset();if(0===e.length)return;++K,this._currentPointsetAndSymbolId={pointsetId:K,symbolId:(0,r.ensureNotNull)(this._model.mainSeries().seriesSource().symbolInstanceId())};const t=(0,b.getServerInterval)(this.properties().childs().interval.value());this._model.chartApi().createPointset(this._currentPointsetIdWithPrefix(),"turnaround",this._currentPointsetAndSymbolId.symbolId,t,e,this.onData.bind(this))}finish(){}realign(){this.calcIsActualSymbol(),this.isFixed()||this.isSourceHidden()||this._model.lineBeingCreated()===this||this._model.lineBeingEdited()===this||this._currentPointsetAndSymbolId?.symbolId===this._model.mainSeries().seriesSource().symbolInstanceId()||this._clearServerPoints(),null===this._model.mainSeries().symbolInfo()&&(this._alignerCache=null),this.updateAllViews((0,M.sourceChangeEvent)(this.id()))}stop(){this._clearServerPoints()}restart(){this.isFixed()||(this._currentPointsetAndSymbolId=null,this.createServerPoints())}isStarted(){return null!==this._currentPointsetAndSymbolId}convertYCoordinateToPriceForMoving(e,t){const i=(0,r.ensureNotNull)(this.priceScale());if(i.isEmpty())return null;const s=this.ownerSource(),n=(0,r.ensure)((s||t)?.firstValue());return i.coordinateToPrice(e,n)}syncMultichartState(e){const t={points:this._timePoint,pointPositionPercents:this.positionPercents(),interval:this._model.mainSeries().interval()},i=this.linkKey().value();if(null!==i&&this.isSynchronizable()){const s={model:this._model,linkKey:i,symbol:this._model.mainSeries().symbol(),finalState:t,changes:e};(0,V.finishChangingLineTool)(s)}}enableCurrentIntervalVisibility(){let e=this.properties().childs().intervalsVisibilities.state();void 0!==e&&(e=(0,A.mergeIntervalVisibilitiesDefaults)(e),(0,A.makeIntervalsVisibilitiesVisibleAtInterval)(e,this._model.mainSeries().intervalObj().value()),this.properties().childs().intervalsVisibilities.mergeAndFire(e))}clonePositionOffset(){return this.isFixed()?{barOffset:0,xCoordOffset:20,yCoordOffset:20}:{barOffset:0,xCoordOffset:0,yCoordOffset:-40}}sharingMode(){return this._sharingMode}share(e){
this.isSynchronizable()&&this._sharingMode.setValue(e)}syncLineStyleState(e){if(e)return{zOrder:this.zorder()};const{intervalsVisibilities:t,...i}=this.properties().state(this._syncStateExclusions);return{...i,intervalsVisibilities:(0,A.mergeIntervalVisibilitiesDefaults)(t),zOrder:this.zorder()}}moveLineTool(e){const t=this._model.mainSeries().interval();e.forEach(((e,i)=>this._setPoint(i,{...e,interval:t}))),this._normalizePoints()}targetSignature(){return this._targetSignature.readonly()}setTargetSignature(e){(0,r.assert)(this.supportsTargetSignature()),this._targetSignature.setValue(e)}supportsTargetSignature(){return!1}snapTo45DegreesAvailable(){return!1}alignTo45DegreesPoints(){if(this.snapTo45DegreesAvailable()){const[e,t]=this.points();if(e&&t)return[{...e,pointIndex:0},{...t,pointIndex:1}]}return null}snapPoint45Degree(e,t,i){const s=this._model.timeScale(),n=s.indexToCoordinate(t.index),o=s.indexToCoordinate(e.index)-n,a=(0,r.ensureNotNull)(this.priceScale()),l=t.price,d=e.price,h=(0,r.ensureNotNull)((0,r.ensureNotNull)(this.ownerSource()).firstValue()),u=a.priceToCoordinate(l,h),c=a.priceToCoordinate(d,h)-u,_=Math.round(Math.atan2(o,c)/Math.PI*4);if(2===Math.abs(_))i||(e.price=l);else if(0===Math.abs(_)||4===Math.abs(_))i||(e.index=t.index);else{const t=Math.sqrt(o*o+c*c),i=o<0?-1:1,r=c<0?-1:1;let l=Math.max(Math.abs(c),Math.abs(o));l/=l*Math.sqrt(2)/t;const d=Math.round(s.coordinateToIndex(n+l*i)),_=Math.abs(s.indexToCoordinate(d)-n),p=a.coordinateToPrice(u+_*r,h);e.index=d,e.price=p}}contextMenuStatName(){return"LineToolContextMenu"}_ignoreSourceEvent(e){return e.sourceId!==this.id()}_pointsForPointset(){return this._timePoint.map((({interval:e,time_t:t,offset:i})=>e?[t,i,(0,b.getServerInterval)(e)]:[t,i]))}_setPoint(e,t){this._points[e]&&(this._points[e].index===t.index?this._points[e].price=t.price:this._points[e]=t,this._pointChanged.fire(e))}_correctLastPoint(e){return(0,o.clone)(e)}_snapTo45DegreesApplicable(e){return this.snapTo45DegreesAvailable()&&(e?.shift()||(0,V.alignTo45Degrees)().value())}_normalizePoint(e,t){return{...this._model.timeScale().normalizeBarIndex(e.index),price:e.price,interval:e.interval}}_normalizePointWithoutOffset(e){const t=this._model.timeScale().indexToTimePoint(e.index)??this._utcTimeInCurrentResolution(e);return null===t?null:{price:e.price,time_t:t,offset:0,interval:e.interval}}_normalizePoints(){let e=[];const t=this._model.mainSeries().interval();for(let i=0;i<this._points.length;i++)if(I.Interval.isEqual(this._points[i].interval,t)){if(void 0!==this._points[i].index){const t=this._normalizePoint(this._points[i],i);if(!t.time_t){e=[];break}e.push(t)}}else e.push({...this._timePoint[i],price:this._points[i].price});this._timePoint=e,this._normalizedPointsChanged.fire()}_getStartBarAligner(){const e=this._model.mainSeries().interval();if(null===this._alignerCache||this._alignerCache.resolution!==this._model.mainSeries().interval()){const t=this._model.mainSeries().symbolInfo();if(!t)return null;this._alignerCache={resolution:e,aligner:(0,
h.createTimeToBarTimeAligner)(e,t)}}return this._alignerCache.aligner}_utcTimeInCurrentResolution(e){const t=this._model.timeScale().points(),i=t.firstPoint(),s=t.lastPoint(),n=this._model.mainSeries().syncModel();if(null===i||null===s||null===n)return null;const o=(0,r.ensureNotNull)(t.indexOf(i,!1)),a=(0,r.ensureNotNull)(t.indexOf(s,!1));if(e.index>=o&&e.index<=a)return null;const l=e.index<o?o:a,d=(0,r.ensureNotNull)(t.valueAt(l)),h=e.index-l;return(0,u.extrapolateBarsFrontByCount)(n.barBuilder(),1e3*d,h).time/1e3}_setPaneViews(e,t,i){if(this._isDestroyed)for(const t of e)t.destroy&&t.destroy();else this._paneViews.set(t,e),void 0!==t&&i&&t.onDestroyed().subscribe(this,(()=>this._destroyPanePaneViews(t))),this._model.lightUpdate()}_getPaneViews(e){if(!e||!this.supportsTargetSignature()||!this._targetSignature.value())return this._paneViews.get(e)??[];const t=this._targetSignature.value(),i=[];for(const s of e.studySources())s.signature().value()===t&&i.push(...this._signaturesPaneViews.get(s)??[]);return i}_updateAllPaneViews(e){this._paneViews.forEach((t=>{for(const i of t)i.update(e)}));for(const[,t]of this._signaturesPaneViews)for(const i of t)i.update(e)}_alignPointHorizontallyOrVertically(e){const t=(0,r.ensureNotNull)(this.pointToScreenPoint(e)),i=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).logical),s=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).screen),n=Math.abs(s.x-t.x),o=Math.abs(s.y-t.y);if(n<10&&o<10)return e;return{index:n<o?i.index:e.index,price:n<o?e.price:i.price}}_alignScreenPointHorizontallyOrVertically(e){const t=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).screen),i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y);return i<10&&s<10?e:i<s?new n.Point(t.x,e.y):new n.Point(e.x,t.y)}_correctPoints(e,t){const i=(0,r.ensure)(this._currentMovingPoint?.screen),s=(0,r.ensure)(this._startMovingPoint?.screen),n=i.subtract(s);if(n.length()<1&&!t)return!1;const o=Math.round((0,r.ensure)(this._currentMovingPoint?.logical).index-(0,r.ensure)(this._startMovingPoint?.logical).index);for(const t of e){const e=(0,r.ensureNotNull)(this.pointToScreenPoint(t)).add(n);t.index=t.index+o,t.price=(0,r.ensureNotNull)(this.screenPointToPoint(e)).price}return!0}_correctFixedPoint(e){if(void 0===this._fixedPoint)return{didCorrect:!1,point:e};const t=(0,r.ensureDefined)((0,r.ensureNotNull)(this._currentMovingPoint).screen),i=(0,r.ensureDefined)((0,r.ensureNotNull)(this._startMovingPoint).screen),s=t.subtract(i);return s.length()>=1?{didCorrect:!0,point:e.add(s)}:{didCorrect:!1,point:e}}_currentPointsetIdWithPrefix(){return"pointset_"+(0,r.ensureNotNull)(this._currentPointsetAndSymbolId).pointsetId}_clearServerPoints(){null!==this._currentPointsetAndSymbolId&&this._model.chartApi().isConnected().value()&&this._model.chartApi().removePointset(this._currentPointsetIdWithPrefix()),this._currentPointsetAndSymbolId=null}_createPointProperty(e){const t=this._pointsProperty.childs().points;t.addChild(""+e,new x.Property({}));const i=t[e];i.addChild("price",new k(this,e)),
i.addChild("bar",new U.LineDataSourcePointIndexProperty(this,e))}_createPointsProperties(){this._pointsProperty=new x.Property,this._pointsProperty.addChild("points",new x.Property);for(let e=0;e<this.pointsCount();e++)this._createPointProperty(e)}_alignPointToRangeOfActualData(e){const t=(0,r.ensureNotNull)(this._model.mainSeries().bars().firstIndex()),i=(0,r.ensureNotNull)(this._model.mainSeries().bars().lastIndex());let s=Math.max(e.index,t);return s=Math.min(s,i),{...e,index:s}}_migrateSymbolProperty(e){const t=this._properties.childs();if(t.symbolStateVersion.value()<2){const i=(0,r.ensureNotNull)(this.ownerSource()),s=(0,r.ensureNotNull)(i.symbolSource()),n=this._model.mainSeries();if(s===n)return void t.symbolStateVersion.setValueSilently(2);if(null===n.symbolInfo())return;if(null===s.symbolInfo())return;n.symbolSameAsCurrent(t.symbol.value())&&t.symbol.setValueSilently((0,C.extractLineToolSymbolFromSymbolInfo)(e,s.symbol())),t.symbolStateVersion.setValueSilently(2)}}_migrateZOrder(){const e=this._properties.childs();e.zOrderVersion.value()<2&&(this.ownerSource()===this.model().mainSeries()&&this.setZorder(this.zorder()-this.model().mainSeries().obsoleteZOrder()),e.zOrderVersion.setValueSilently(2))}_preparePoint(e,t){const i=e;return this._snapTo45DegreesApplicable(t)&&this.points().length>=2&&this.snapPoint45Degree(i,this.points()[this.points().length-2]),i}_addPointIntenal(e,t,i){this._points.push({...e,interval:this._model.mainSeries().interval()});const s=this._points.length===this.pointsCount();return s?(this._lastPoint=null,i||(this._normalizePoints(),this.createServerPoints())):this._lastPoint=e,this._pointAdded.fire(this._points.length-1),s}_onSourceHiddenMayChange(){this.isSourceHidden()&&this._model.selectionMacro((e=>{e.removeSourceFromSelection(this)})),this._model.invalidate(f.InvalidationMask.validateAction((()=>{this!==this._model.lineBeingCreated()&&(this._isDestroyed||this.processHibernate())})))}_saveAlertIdInState(){return!0}_onPointsetUpdated(e){if(0===e.length)return;const t=this.properties().childs().interval.value();for(const{index:i,value:s}of e){const{price:e,interval:n=t}=(0,r.ensureDefined)(this._timePoint[i]),[o,a]=s,l={index:o,time:a,price:e,interval:n};if(this._points.length<=i){const e=this._points.push(l);this._pointAdded.fire(e-1)}else this._points[i]=l,this._pointChanged.fire(i)}{const e=this;e.recalculateStateByData&&e.recalculateStateByData()}this._onPointsetUpdatedDelegate.fire(),this.updateAllViewsAndRedraw((0,M.sourceChangeEvent)(this.id()))}_onMainSeriesSymbolResolved(){const e=this.ownerSource();null===e||this._model.mainSeries()===e.symbolSource()||this.isSourceHidden()||this.createServerPoints()}_readyToCreatePointset(){return this._timePoint.length>0}_propertiesStateExclusions(){return[]}_syncLineStyleIfNeeded(e){const t=this.linkKey().value();t&&!this._syncLineStyleMuted&&this._syncLineStyleChanges(t,this.syncLineStyleState(e))}_muteSyncLineStyle(){this._syncLineStyleMuted=!0}_unmuteSyncLineStyleWithoutApplyingChanges(){this.propertiesChanged(),
this._syncLineStyleMuted=!1}_applyTemplateImpl(e){e.intervalsVisibilities=(0,A.mergeIntervalVisibilitiesDefaults)(e.intervalsVisibilities);const t=this.properties();t.applyTemplate(e,(0,B.factoryDefaults)(this.toolname.toLowerCase())),t.saveDefaults(),this.propertiesChanged()}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_getAlertPlots(){return[]}_getUndoHistory(){return this._model.undoModel().undoHistory()}async _synchronizeAlert(e){const t=this._getUndoHistory();if(!this._undoCheckpointAlert&&!this._alertUndoMode){const e=t.undoStack().pop();this._undoCheckpointAlert=t.createUndoCheckpoint(),e&&t.undoStack().push(e)}const i=async e=>{const t=e.description()!==e.defaultDescription(),i=await this._model.mainSeries().stateForAlertAsync();if(this._isDestroyed)return;const s=(0,r.ensureNotNull)(await this.stateForAlertAsync());this._isDestroyed||(e.startEditing(),e.setSymbol(i.symbolString),e.setResolution(s.interval),e.setDrawingLikeState(s),t||e.resetToDefaultDescription(),e.finishEditing(),this._localAndServerAlertsMismatch=!0)},s=()=>{this._alertUndoMode=!0,t.undoToCheckpoint((0,r.ensureDefined)(this._undoCheckpointAlert)),setTimeout((()=>{this._alertUndoMode=!1,this._localAndServerAlertsMismatch=!1}),0)},n=e=>{e instanceof Error&&"not_exists"===e.message||(W.logError("Getting alert failed: "+e),s())},o=e=>{void 0!==this._alertRestartDebounceTimeoutId&&clearTimeout(this._alertRestartDebounceTimeoutId),this._alertRestartDebounceTimeoutId=setTimeout((async()=>{const t=await(0,g.getChartAlertsFacade)();this._isDestroyed||(t.restartAlert(e,{success:()=>this._localAndServerAlertsMismatch=!1,error:e=>n(new Error(e)),complete:()=>delete this._undoCheckpointAlert,actionSource:"drawing_sync"}),delete this._alertRestartDebounceTimeoutId)}),500)};if((0,m.canPlaceAlertOnResolution)(this._model.mainSeries().interval()))try{const t=await this.getAlert();if(!t)return void W.logError("Failed to get alert, drawing and alert are not synchronized");if(this._isDestroyed)return;if(await i(t),this._isDestroyed)return;e&&o(t)}catch(e){n(e)}else{if(this._isDestroyed)return;this._alertUndoMode||((0,S.showGoProAlertsOnSecondsDialog)(),s(),delete this._undoCheckpointAlert)}}_linePointsToAlertPlot(e,t,i,s){if(2!==e.length)return W.logError("[Drawing Alert] Wrong points"),null;const n=this._model.timeScale();return n.isEmpty()?null:{type:"LinePlot",title:t||this.translatedType(),timestamp:(0,r.ensureNotNull)(n.indexToTimePoint(0)),offset1:e[0].index,offset2:e[1].index,price1:e[0].price,price2:e[1].price,extendBackward:i||!1,extendForward:s||!1}}_getAlertCreationAvailable(){return y.alertsAvailable&&super._getAlertCreationAvailable()&&!this._areAlertsOnLineToolProhibited()&&!this._hasAlert.value()}_onAnchoredChange(){if(this.isFixed()){const e=(0,r.ensureNotNull)(this.pointToScreenPoint(this.points()[0]));this.addFixedPoint(e)}else{if(!this._fixedPoint)return;const e=(0,r.ensureNotNull)(this.screenPointToPoint(this._fixedPoint));this._points[0]={...e,interval:this._model.mainSeries().interval()},this.startChanging(),
this.setPoint(0,e),this.endChanging(!1,!1),this._timePoint[0]=this._normalizePoint(this._points[0],0),this.clearFixedPoint()}const e=this.linkKey().value();null!==e&&this.isSynchronizable()&&(0,V.restoreLineToolState)({model:this._model,linkKey:e,state:this.state()})}_syncLineStyleChanges(e,t,i){this.anchorable()&&this.isFixed()!==Boolean(this._positionPercents)&&this._onAnchoredChange(),(0,V.changeLineStyle)({linkKey:e,state:t,alertId:i,model:this._model})}_updateAdjustedToSplitTimeValue(e){const t=this._properties.childs().adjustedToSplitTime,i=window.ChartApiInstance.serverTime()/1e3;e?t.setValueSilently(i):t.setValue(i)}_createSignatureSourcePaneViews(e){return[]}_updateSignaturesPaneViews(){const e=this.targetSignature().value();if(null!==e||0!==this._signaturesPaneViews.size){for(const[t,i]of this._signaturesPaneViews)t.signature().value()!==e&&(i.forEach((e=>e.destroy?.())),this._signaturesPaneViews.delete(t));for(const t of this._model.studiesWV(!0).value())t.signature().value()!==e||this._signaturesPaneViews.has(t)||this._signaturesPaneViews.set(t,this._createSignatureSourcePaneViews(t))}}static _configureProperties(e){if(this._addCollectedProperties(e),e.hasChild("symbolStateVersion")||e.addProperty("symbolStateVersion",1),e.hasChild("zOrderVersion")||e.addProperty("zOrderVersion",1),e.hasChild("visible")||e.addProperty("visible",!0),e.hasChild("frozen")||e.addProperty("frozen",!1),e.hasChild("symbol")||e.addProperty("symbol",""),e.hasChild("currencyId")||e.addProperty("currencyId",null),e.hasChild("unitId")||e.addProperty("unitId",null),e.hasChild("adjustedToSplitTime")||e.addProperty("adjustedToSplitTime",null),e.hasChild("intervalsVisibilities")){const t=(0,o.merge)((0,o.clone)(w.intervalsVisibilitiesDefaults),e.childs().intervalsVisibilities.state());e.removeProperty("intervalsVisibilities"),e.addChild("intervalsVisibilities",new L.IntervalsVisibilitiesProperty(t))}else e.addChild("intervalsVisibilities",new L.IntervalsVisibilitiesProperty(w.intervalsVisibilitiesDefaults));e.hasChild("title")||e.addProperty("title",""),["symbolStateVersion","zOrderVersion","visible","frozen","symbol","currencyId","unitId","symbolInfo","points","interval","title"].forEach((t=>e.addExcludedKey(t,5))),e.hasChild("singleChartOnly")&&e.removeProperty("singleChartOnly"),e.hasChild("font")&&e.removeProperty("font")}static _addCollectedProperties(e){e.hasChild("linewidth")&&e.addChild("linesWidths",new O.LineToolWidthsProperty([(0,r.ensureDefined)(e.child("linewidth"))])),e.hasChild("linecolor")&&e.addChild("linesColors",new O.LineToolColorsProperty([(0,r.ensureDefined)(e.child("linecolor"))])),e.hasChild("backgroundColor")&&e.addChild("backgroundsColors",new O.LineToolColorsProperty([(0,r.ensureDefined)(e.child("backgroundColor"))])),e.hasChild("textColor")&&e.addChild("textsColors",new O.LineToolColorsProperty([(0,r.ensureDefined)(e.child("textColor"))])),e.hasChild("linestyle")&&e.addChild("linesStyles",new O.LineToolCollectedProperty([(0,r.ensureDefined)(e.child("linestyle"))])),
["linesWidths","linesColors","backgroundsColors","textsColors","linesStyles"].forEach((t=>{e.addExcludedKey(t,7)}))}_areAlertsOnLineToolProhibited(){return null!==this._ownerSource&&!this._ownerSource.canHasAlertOnLineTools()}_removeAlertSubscriptions(){this._unsubscribeAlertCallbacks?.(),this._unsubscribeAlertCallbacks=void 0}_addAlertSubscriptions(e,t={}){if(void 0!==this._unsubscribeAlertCallbacks)return;const i=this.properties().child("extendLeft"),s=this.properties().child("extendRight"),n=e.destroyed().spawn(),r=e.active().spawn();r.subscribe((e=>this._alertStatus.setValue(e?2:3)),{callWithLast:!0}),n.subscribe(this.removeAlert.bind(this)),void 0!==i&&i.subscribe(this,(()=>this.synchronizeAlert(!1))),void 0!==s&&s.subscribe(this,(()=>this.synchronizeAlert(!1))),this._unsubscribeAlertCallbacks=()=>{n.destroy(),r.destroy(),void 0!==i&&i.unsubscribeAll(this),void 0!==s&&s.unsubscribeAll(this)}}_destroyPanePaneViews(e){const t=this._paneViews.get(e);if(void 0!==t)for(const e of t)e.destroy&&e.destroy();void 0!==e&&e.onDestroyed().unsubscribeAll(this),this._paneViews.delete(e)}_copyPricesWithoutNormalization(){const e=Math.min(this._points.length,this._timePoint.length);for(let t=0;t<e;t++)this._timePoint[t].price=this._points[t].price}async _getChartAlert(){const e=await(0,g.getChartAlertsFacade)();return new Promise(((t,i)=>{e.getAlert((0,r.ensureDefined)(this._alertId),{success:t,error:i})}))}async _syncAlertWithAlertFacade(e={}){try{const t=await this.getAlert();if(!t)return;this._addAlertSubscriptions(t,e)}catch(e){if(e instanceof Error&&"not_exists"===e.message&&this.hasAlert().value()){this._alertStatus.setValue(0);return void(await(0,g.getChartAlertsFacade)()).removeAlertFromAllChartsSilently(this.id(),(0,r.ensureDefined)(this._alertId))}W.logError("Failed to set alert, alert will not be saved with drawing in chart")}}async _awaitForPointset(){const e={};try{await Promise.race([new Promise(((e,t)=>{setTimeout((()=>t(new Error("Timeout"))),3e3)})),new Promise((t=>{this.pointsetUpdated().subscribe(e,(()=>t()))}))])}catch(e){throw e}finally{this.pointsetUpdated().unsubscribeAll(e)}}}},825079:(e,t,i)=>{i.d(t,{lineToolsLocalizedNames:()=>n});var s=i(444372);const n={LineTool5PointsPattern:s.t(null,void 0,i(942231)),LineToolABCD:s.t(null,void 0,i(246712)),LineToolArc:s.t(null,void 0,i(659324)),LineToolArrow:s.t(null,void 0,i(511858)),LineToolArrowMarkDown:s.t(null,void 0,i(673193)),LineToolArrowMarkLeft:s.t(null,void 0,i(401949)),LineToolArrowMarkRight:s.t(null,void 0,i(886275)),LineToolArrowMarkUp:s.t(null,void 0,i(162453)),LineToolBalloon:s.t(null,void 0,i(770540)),LineToolComment:s.t(null,void 0,i(309818)),LineToolBarsPattern:s.t(null,void 0,i(381994)),LineToolBezierCubic:s.t(null,void 0,i(77125)),LineToolBezierQuadro:s.t(null,void 0,i(678609)),LineToolBrush:s.t(null,void 0,i(243539)),LineToolCallout:s.t(null,void 0,i(925381)),LineToolCircleLines:s.t(null,void 0,i(584031)),LineToolCypherPattern:s.t(null,void 0,i(193191)),LineToolDateAndPriceRange:s.t(null,void 0,i(247017)),
LineToolDateRange:s.t(null,void 0,i(485444)),LineToolDisjointAngle:s.t(null,void 0,i(91544)),LineToolElliottCorrection:s.t(null,void 0,i(980943)),LineToolElliottDoubleCombo:s.t(null,void 0,i(75112)),LineToolElliottImpulse:s.t(null,void 0,i(861114)),LineToolElliottTriangle:s.t(null,void 0,i(872359)),LineToolElliottTripleCombo:s.t(null,void 0,i(76129)),LineToolEllipse:s.t(null,void 0,i(978996)),LineToolExtended:s.t(null,void 0,i(452788)),LineToolFibChannel:s.t(null,void 0,i(659005)),LineToolFibCircles:s.t(null,void 0,i(182330)),LineToolFibRetracement:s.t(null,void 0,i(855986)),LineToolFibSpeedResistanceArcs:s.t(null,void 0,i(633880)),LineToolFibSpeedResistanceFan:s.t(null,void 0,i(202395)),LineToolFibSpiral:s.t(null,void 0,i(239014)),LineToolFibTimeZone:s.t(null,void 0,i(930622)),LineToolFibWedge:s.t(null,void 0,i(485042)),LineToolFlagMark:s.t(null,void 0,i(514600)),LineToolImage:s.t(null,void 0,i(868065)),LineToolFlatBottom:s.t(null,void 0,i(745051)),LineToolAnchoredVWAP:s.t(null,void 0,i(584541)),LineToolGannComplex:s.t(null,void 0,i(844763)),LineToolGannFixed:s.t(null,void 0,i(960707)),LineToolGannFan:s.t(null,void 0,i(748683)),LineToolGannSquare:s.t(null,void 0,i(947460)),LineToolHeadAndShoulders:s.t(null,void 0,i(921928)),LineToolHorzLine:s.t(null,void 0,i(121795)),LineToolHorzRay:s.t(null,void 0,i(325487)),LineToolIcon:s.t(null,void 0,i(37913)),LineToolEmoji:s.t(null,void 0,i(273456)),LineToolSticker:s.t(null,void 0,i(443114)),LineToolInsidePitchfork:s.t(null,void 0,i(141686)),LineToolNote:s.t(null,void 0,i(986631)),LineToolTextNote:s.t(null,void 0,i(794389)),LineToolSignpost:s.t(null,void 0,i(467751)),LineToolParallelChannel:s.t(null,void 0,i(559256)),LineToolPitchfan:s.t(null,void 0,i(234156)),LineToolPitchfork:s.t(null,void 0,i(919634)),LineToolPolyline:s.t(null,void 0,i(239949)),LineToolPath:s.t(null,void 0,i(800371)),LineToolPrediction:s.t(null,void 0,i(920138)),LineToolPriceLabel:s.t(null,void 0,i(91282)),LineToolArrowMarker:s.t(null,void 0,i(936352)),LineToolPriceRange:s.t(null,void 0,i(768941)),LineToolProjection:s.t(null,void 0,i(375747)),LineToolRay:s.t(null,void 0,i(550318)),LineToolRectangle:s.t(null,void 0,i(426001)),LineToolCircle:s.t(null,void 0,i(191944)),LineToolRegressionTrend:s.t(null,void 0,i(802460)),LineToolRiskRewardLong:s.t(null,void 0,i(674832)),LineToolRiskRewardShort:s.t(null,void 0,i(508075)),LineToolFixedRangeVolumeProfile:s.t(null,{context:"study"},i(925705)),LineToolAnchoredVolumeProfile:s.t(null,{context:"study"},i(689633)),LineToolRotatedRectangle:s.t(null,void 0,i(56820)),LineToolSchiffPitchfork:s.t(null,void 0,i(657681)),LineToolSchiffPitchfork2:s.t(null,void 0,i(942608)),LineToolSineLine:s.t(null,void 0,i(839090)),LineToolText:s.t(null,{context:"tool"},i(691405)),LineToolTextAbsolute:s.t(null,void 0,i(642669)),LineToolThreeDrivers:s.t(null,void 0,i(46982)),LineToolTimeCycles:s.t(null,void 0,i(746852)),LineToolTrendAngle:s.t(null,void 0,i(35757)),LineToolTrendBasedFibExtension:s.t(null,void 0,i(680583)),LineToolTrendBasedFibTime:s.t(null,void 0,i(272159)),
LineToolTrendLine:s.t(null,void 0,i(197339)),LineToolInfoLine:s.t(null,void 0,i(715992)),LineToolTriangle:s.t(null,void 0,i(901671)),LineToolTrianglePattern:s.t(null,void 0,i(390148)),LineToolVertLine:s.t(null,void 0,i(529535)),LineToolCrossLine:s.t(null,void 0,i(974334)),LineToolHighlighter:s.t(null,void 0,i(969476)),LineToolPriceNote:s.t(null,void 0,i(297512)),LineToolVbPFixed:s.t(null,void 0,i(840693)),LineToolGhostFeed:s.t(null,void 0,i(546808)),LineToolTable:s.t(null,void 0,i(17981))};n.LineToolTweet=s.t(null,void 0,i(636549)),n.LineToolIdea=s.t(null,void 0,i(215982)),n.LineToolNoteAbsolute=s.t(null,void 0,i(363209))},968849:(e,t,i)=>{i.d(t,{StudyLineDataSource:()=>f,isStudyLineTool:()=>P});var s=i(957606),n=i(23369),r=i(294721),o=i(327734),a=i(446448),l=i(767405),d=i(555141),h=i(557476),u=i(45208),c=i(763268),_=i(830842),p=i(143406),g=i(471220);class m extends g.StatusProviderBase{constructor(e){super(),this._source=e}errorStatus(){const e=this._source.status();return e.type===p.StudyStatusType.Error?{error:this.sourceStatusText(),solutionId:(0,p.studyStatusSolutionId)(e),title:(0,p.studyStatusTitle)(e),studyFeature:(0,p.studyStatusFeature)(e)}:null}getSplitTitle(){return this._source.titleInParts()}getInputsTitles(){return null}text(){return this._source.translatedType()}sourceStatusText(){return(0,p.convertStudyStatusToString)(this._source.status(),!0)}}var S=i(728587),y=i(619790);class v extends y.StatusView{constructor(e){super(e.statusProvider({}))}getSplitTitle(){return this._statusProvider.getSplitTitle()}}function P(e){return e instanceof f}class f extends n.LineDataSource{constructor(e,t,s,n,r,o){super(e,n,r,o),this._indexes=null,this._inputs=null,this._definitionsViewModel=null,this._pointsetPoints=null,this._loadedPlots=null,this._loadedGraphics=null,this._beingCreatedPaneView=null,this._anchorsPaneView=null,this._isLegendDisplayed=!1,Promise.all([Promise.all([i.e(33570),i.e(13946),i.e(93235),i.e(21049),i.e(94874),i.e(70341),i.e(86034),i.e(51583)]).then(i.bind(i,312766)),Promise.all([i.e(33570),i.e(13946),i.e(93235),i.e(21049),i.e(94874),i.e(70341),i.e(86034),i.e(51583)]).then(i.bind(i,371554))]).then((t=>{const{LineToolBeingCreatedPaneView:i}=t[0],{StudyLineDataSourceAnchorsPaneView:s}=t[1];this._beingCreatedPaneView=new i(this,e),this._anchorsPaneView=new s(this,this.model()),this._model.lightUpdate()})),this._metaInfo=t,this._dataSource=new d.ExtendedStudyDataSource(e.chartApi(),e.mainSeries(),s,t),this._dataSource.dataCleared().subscribe(this,this._onDataCleared),this._dataSource.dataUpdated().subscribe(this,this._onDataUpdated),this._dataSource.studyStatusChanged().subscribe(this,this._onStudyStatusChanged),this._statusProvider=new m(this),this._statusView=new v(this),this._showStudyArgumentsProperty=e.properties().childs().paneProperties.childs().legendProperties.childs().showStudyArguments}isDisplayedInLegend(){return this._isLegendDisplayed}titleInParts(){const e=[];if(this._showStudyArgumentsProperty.value()&&this._inputs)for(const t of this._metaInfo.inputs){
if(!0===t.isHidden||"bool"===t.type)continue;const i=this._inputs[t.id];e.push(i.toString())}return[this.name(),e]}destroy(){this._dataSource.dataUpdated().unsubscribeAll(this),this._dataSource.dataCleared().unsubscribeAll(this),this._dataSource.studyStatusChanged().unsubscribeAll(this),this._dataSource.destroy(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),this._unsubscribeApplyInputsOnSeriesCompleted(),this._isDestroyed=!0,super.destroy()}stop(){super.stop(),this._stopDataSource()}start(){super.start(),this._startDataSource()}metaInfo(){return this._metaInfo}graphicsInfo(){return this._metaInfo.graphics}series(){return this._model.mainSeries()}translatedType(){return this._metaInfo.description}name(){return this._metaInfo.description}studyId(){return this._metaInfo.id}setPoint(e,t,i){super.setPoint(e,this._preparePoint(t,i))}move(e){}clearData(){this._pointsetPoints=null,this._clearAllDataExceptPointsetPoints(),this._onStudyInputsMayChange(),this.updateAllViews((0,_.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),super.clearData()}data(){return this.plots()}plots(){return this._loadedPlots||this._dataSource.plots()}graphics(){return this._loadedGraphics||this._dataSource.graphics()}valueAt(e,t){return this.ownerSource()?.symbolSource().valueAt(e,t)??null}firstValue(){return this._model.mainSeries().firstValue()}state(e){const t={...super.state(e),metaInfo:this.metaInfo().state()};return e&&(t.data=this.plots().state(),t.nonseriesindexes=this._indexes,t.graphics=(0,a.saveStudyGraphics)(this.graphics(),null)),t}restoreData(e){void 0!==e.data&&(this._loadedPlots=new s.PlotList((0,u.studyPlotFunctionMap)(this._metaInfo),u.studyEmptyPlotValuePredicate),this._loadedPlots.restoreState(e.data)),this._indexes=e.nonseriesindexes??this._indexes,this._loadedGraphics=e.graphics?(0,a.loadStudyGraphics)(e.graphics):this._loadedGraphics}getPropertyDefinitionsViewModel(){return null===this._definitionsViewModel?this._getPropertyDefinitionsViewModelClass().then((e=>null===e||this._isDestroyed?null:(null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this._model.undoModel(),this)),this._definitionsViewModel))):Promise.resolve(this._definitionsViewModel)}paneViews(e){let t=[];if(this.isSourceHidden())return t;if(this._isReady()&&this._changeStatesStack.isEmpty()){const i=super.paneViews(e);null!==i&&(t=t.concat(i))}else null!==this._beingCreatedPaneView&&t.push(this._beingCreatedPaneView);return null!==this._anchorsPaneView&&t.push(this._anchorsPaneView),t}propertiesChanged(e){super.propertiesChanged(e),this._onStudyInputsMayChange()}dataAndViewsReady(){return super.dataAndViewsReady()&&this._isReady()}endChanging(e,t){const i=super.endChanging(e,t);return i.indexesChanged?this.clearData():this._updateAnchorsPrice(!0),i}moveData(e){this._dataSource.moveData(e)}restorePoints(e,t,i){super.restorePoints(e,t,i),this._updateAnchorsPrice(!0)}statusProvider(e){return this._statusProvider}alertSourceModel(){return null}statusView(){return this._statusView}
legendView(){return null}dataProblemModel(){return null}dataUpdatedModeModel(){return null}marketStatusModel(){return null}onStatusChanged(){return this._dataSource.studyStatusChanged()}status(){return this._dataSource.studyStatus()}recalcStudyIfNeeded(){}stateForAlert(){return null}static createPropertiesFromStudyMetaInfoAndState(e,t,i,s,n){const r=(0,c.prepareStudyPropertiesForLoadChart)(e,t,i,s,void 0,n);return this._configureProperties(r),r}_getPointsetPoints(){return this._pointsetPoints}_onStudyStatusChanged(e,t){let i;switch(t.type){case h.StudyStatusType.Error:i=!0;break;case h.StudyStatusType.Completed:i=!1;break;default:return}if(i===this._isLegendDisplayed)return;this._isLegendDisplayed=i;const s=this._model.paneForSource(this);if(s){const e=this._model.panes().indexOf(s),t=S.InvalidationMask.invalidateLegendWidgetLayout(e);this.model().invalidate(t)}}_studyId(){return this._dataSource.studyId()}_isReady(){return!0}_updateAllPaneViews(e){super._updateAllPaneViews(e),this._beingCreatedPaneView?.update(),this._anchorsPaneView?.update(e)}_getPointTime(e,t){const i=e.index,s=this._model.timeScale().indexToTimePoint(i);return null!==s?s:t||void 0===e.time?null:this._utcTimeInCurrentResolution(e)}_updateAnchorsPrice(e){}_onPointsetUpdated(e){super._onPointsetUpdated(e),this._pointsetPoints=this._points.map((e=>({price:e.price,index:e.index,time:e.time}))),this._onStudyInputsMayChange()}_onDataCleared(){this.updateAllViews((0,_.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),this._model.updateSource(this)}_onDataUpdated(e,t,i){this._updateAnchorsPrice(),this.updateAllViews((0,_.sourceChangeEvent)({sourceId:this.id(),firstUpdatedTimePointIndex:e[0]?.index})),this._model.updateSource(this)}_onStudyInputsMayChange(){let e=null;const t=this._pointsetPoints;if(t?.length===this.pointsCount()){if(e=this._studyInputs(t),e){const t=this.metaInfo().inputs.map((e=>e.id));for(const i of Object.keys(e))t.includes(i)||delete e[i]}}else this._isDataSourceStarted()&&this._stopDataSource(!1);e?this._unsubscribeApplyInputsOnSeriesCompleted():this._subscribeApplyInputsOnSeriesCompleted(),this._areInputsEqual(this._inputs,e)||(this._applyStudyInputs(e),e?this._isDataSourceStarted()||this._startDataSource():(this._clearAllDataExceptPointsetPoints(),this.updateAllViews((0,_.sourceChangeEvent)(this.id()))))}_preparePoint(e,t){return super._preparePoint(this._alignPointToRangeOfActualData(e),t)}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_subscribeApplyInputsOnSeriesCompleted(){this._unsubscribeApplyInputsOnSeriesCompleted(),this._model.mainSeries().dataEvents().completed().subscribe(this,(()=>this._onStudyInputsMayChange()),!0)}_unsubscribeApplyInputsOnSeriesCompleted(){this._model.mainSeries().dataEvents().completed().unsubscribeAll(this)}_onInputsChanged(){this.hasAlert().value()&&(this._localAndServerAlertsMismatch=!0)}_clearAllDataExceptPointsetPoints(){this._loadedPlots=null,this._indexes=null,this._loadedGraphics=null,this._dataSource.clearData()}_stopDataSource(e=!0){
this._isDestroyed||(this._dataSource.stop(),e&&this.clearData())}_startDataSource(){this._isDestroyed||null===this._inputs||this._dataSource.start()}_isDataSourceStarted(){return this._dataSource.isStarted()}static _createPropertiesFromStudyIdAndState(e,t){const i=o.StudyMetaInfo.getStudyPropertyRootNameById(e),s=new r.DefaultProperty({defaultName:i,state:t});return this._configureProperties(s),s}static _configureProperties(e){super._configureProperties(e),e.removeExcludedKey("intervalsVisibilities",1),e.removeProperty("showLegendValues"),e.removeProperty("showLegendInputs")}_areInputsEqual(e,t){return null===t?null===e:null!==e&&(0,l.areStudyInputsEqual)(this._metaInfo.inputs,e,t)}_applyStudyInputs(e){this._inputs=e,null!==e&&this._dataSource.setInputs(e),this._onInputsChanged()}}},555141:(e,t,i)=>{i.d(t,{ExtendedStudyDataSource:()=>r});var s=i(28987),n=i(143406);class r extends s.StudyDataSource{constructor(e,t,i,s){super(e,t.seriesSource(),i,s),this._series=t}_createStudyError(e){return(0,n.createStudyError)(this._getStudyErrorDescription(e),this._series.symbolInfo()?.exchange)}}},557476:(e,t,i)=>{var s;i.d(t,{StudyStatusType:()=>s}),function(e){e[e.Undefined=0]="Undefined",e[e.Loading=1]="Loading",e[e.Completed=2]="Completed",e[e.Error=3]="Error"}(s||(s={}))},28987:(e,t,i)=>{i.r(t),i.d(t,{StudyDataSource:()=>p});var s=i(650151),n=i(251924),r=i(957606),o=i(292045),a=i(327734),l=i(887947),d=i(45208),h=i(139096),u=i(557476);const c=(0,i(735566).getLogger)("Chart.StudyDataSource");var _;!function(e){e[e.Idle=0]="Idle",e[e.AwaitingConnection=1]="AwaitingConnection",e[e.AwaitingParent=2]="AwaitingParent",e[e.AwaitingFirstDataUpdate=3]="AwaitingFirstDataUpdate",e[e.Active=4]="Active"}(_||(_={}));class p{constructor(e,t,i,s,o=!1){this._inputs=null,this._status=_.Idle,this._studyId=null,this._turnaroundCounter=1,this._studyStatus={type:u.StudyStatusType.Undefined},this._studyStatusChanged=new n.Delegate,this._dataCleared=new n.Delegate,this._dataUpdated=new n.Delegate,this._boundOnGatewayIsConnectedChanged=this._onGatewayIsConnectedChanged.bind(this),this._ongoingDataUpdate=Promise.resolve(),this._gateway=e,this._metaInfo=s,this._forceUseExclamationMark=o,this._seriesSource=t,this._turnaroundPrefix=i,this._plots=new r.PlotList((0,d.studyPlotFunctionMap)(s),d.studyEmptyPlotValuePredicate),this._gateway.isConnected().subscribe(this._boundOnGatewayIsConnectedChanged),this._graphics=new h.LiveStudyGraphics(s.graphics)}destroy(){this.stop(),this._gateway.isConnected().unsubscribe(this._boundOnGatewayIsConnectedChanged),this._seriesSource.dataEvents().created().unsubscribeAll(this)}metaInfo(){return this._metaInfo}inputs(){return this._inputs}setInputs(e){this._inputs=e,null!==this._studyId&&(this._turnaroundCounter++,this._onStudyStatusChangedTo({type:u.StudyStatusType.Undefined}),this._gateway.modifyStudy(this._studyId,this._turnaround(),e,this._onMessage.bind(this)),this._status===_.Active&&this._changeStatusTo(_.AwaitingFirstDataUpdate))}isStarted(){return this._status!==_.Idle}isActive(){return this._status===_.Active}
start(){this.isStarted()?c.logNormal("start: data source is already started, nothing to do"):((0,s.assert)(null!==this._inputs,"Inputs should be defined when starting a study data source"),this._gateway.isConnected().value()?this._createStudy():this._changeStatusTo(_.AwaitingConnection))}stop(){this.isStarted()?(null!==this._studyId&&(this._gateway.isConnected().value()&&this._gateway.removeStudy(this._studyId),this._studyId=null,this._onStudyStatusChangedTo({type:u.StudyStatusType.Undefined})),this._changeStatusTo(_.Idle)):c.logNormal("stop: data source is already stopped, nothing to do")}studyId(){return this._studyId}studyStatus(){return this._studyStatus}studyStatusChanged(){return this._studyStatusChanged}plots(){return this._plots}graphics(){return this._graphics}clearData(){this._plots.clear(),this._graphics.clear(),this._dataCleared.fire()}stopAndStealData(){(0,s.assert)(this._status===_.Active,"Couldn't steal data from non-active data source"),this.stop();const e=this._plots,t=this._graphics.extract();return this._plots=new r.PlotList((0,d.studyPlotFunctionMap)(this._metaInfo),d.studyEmptyPlotValuePredicate),{plots:e,graphics:t}}dataCleared(){return this._dataCleared}dataUpdated(){return this._dataUpdated}moveData(e){this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._plots.move(e)}))}pendingUpdatesReady(){return this._ongoingDataUpdate}_createStudyError(e){return{type:u.StudyStatusType.Error,errorDescription:this._getStudyErrorDescription(e)}}_getStudyErrorDescription(e){return"string"==typeof e?{error:e.split(":",2)[0]}:e}_changeStatusTo(e){(0,s.assert)(this._status!==e,"Source and destination status should be distinct"),c.logNormal(`Status changed from ${_[this._status]} to ${_[e]}`),this._status=e}_createStudy(){const e=this._seriesSource.instanceId();null!==e?this._createStudyUsingParentId(e):(this._changeStatusTo(_.AwaitingParent),this._seriesSource.dataEvents().created().subscribe(this,this._onSeriesCreated,!0))}_createStudyUsingParentId(e){(0,s.assert)(this._status!==_.Active,'Status should not be "Active" when creating a study'),(0,s.assert)(this._studyStatus.type===u.StudyStatusType.Undefined,'Study status should be "Undefined" when creating a study'),(0,s.assert)(null===this._studyId,"Study id should be empty when creating a study"),this._studyId=(0,l.makeNextStudyId)(),this._gateway.createStudy(this._studyId,this._turnaround(),e,a.StudyMetaInfo.getStudyIdWithLatestVersion(this.metaInfo(),this._forceUseExclamationMark),(0,s.ensureNotNull)(this._inputs),this._onMessage.bind(this),{id:this._metaInfo.id}),this._changeStatusTo(_.AwaitingFirstDataUpdate)}_onGatewayIsConnectedChanged(e){e?this._onGatewayConnected():this._onGatewayDisconnected()}_onGatewayConnected(){this._status===_.AwaitingConnection&&this._createStudy()}_onGatewayDisconnected(){this._status!==_.Idle&&this._status!==_.AwaitingConnection&&(this._studyId=null,this._changeStatusTo(_.AwaitingConnection),this._studyStatus.type!==u.StudyStatusType.Undefined&&this._onStudyStatusChangedTo({type:u.StudyStatusType.Undefined})),
this._turnaroundCounter=1}_onSeriesCreated(){this._status===_.AwaitingParent&&this._createStudyUsingParentId((0,s.ensure)(this._seriesSource.instanceId()))}_onStudyStatusChangedTo(e){const t=this._studyStatus;this._studyStatus=e,c.logNormal(`Study status type changed from ${u.StudyStatusType[t.type]} to ${u.StudyStatusType[e.type]}`),this._studyStatusChanged.fire(t,e)}_onMessage(e){if("data_update"===e.method){const{customId:t,turnaround:i,plots:n,nonseries:r}=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onDataUpdate(n,(0,s.ensureDefined)(r))}else if("study_loading"===e.method){const[t,i]=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onStudyLoading(e.time)}else if("study_completed"===e.method){const[t,i]=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onStudyCompleted(e.time)}else if("study_error"===e.method){const[t,i,s,n]=e.params;t===this._studyId&&this._checkTurnaround(i)&&this._onStudyError(s,n,e.time)}else"clear_data"===e.method&&this._checkTurnaround(e.params.turnaround)&&this.clearData()}_onDataUpdate(e,t){const i=(0,o.unpackNonSeriesData)(t.d);return this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>i),(()=>i)).then(this._onDataUnpacked.bind(this,e,t.indexes)),this._ongoingDataUpdate}_onDataUnpacked(e,t,i){this._status!==_.Idle&&(this._status===_.AwaitingFirstDataUpdate&&(this._changeStatusTo(_.Active),this.clearData()),this._mergePlots(e),null!==i&&(i.indexes_replace?((0,s.assert)("nochange"!==t),this._graphics.replaceIndexesTo(t)):("nochange"!==t&&this._graphics.replaceIndexesTo(t),void 0!==i.graphicsCmds&&this._graphics.processCommands(i.graphicsCmds))),this._dataUpdated.fire(e,i,t))}_onStudyLoading(e){this._onStudyStatusChangedTo({type:u.StudyStatusType.Loading,startTime:Date.now()})}_onStudyError(e,t,i){this.clearData(),this._onStudyStatusChangedTo(this._createStudyError(e))}_onStudyCompleted(e){this._onStudyStatusChangedTo({type:u.StudyStatusType.Completed})}_mergePlots(e){this._plots.merge(e)}_turnaround(){return`${this._turnaroundPrefix}${this._turnaroundCounter}`}_checkTurnaround(e){const t=this._turnaround();return e===t||e===this._seriesSource.turnaround()||e===`${this._seriesSource.turnaround()}_${t}`}}},569322:(e,t,i)=>{i.d(t,{areEqualSymbols:()=>o,compareSymbolParams:()=>h,symbolParams:()=>d,symbolSameAsCurrent:()=>l});i(687037);var s=i(104779),n=i(666310);const r=!0;function o(e,t){return void 0===e?void 0===t:void 0!==t&&(r?e.toUpperCase()===t.toUpperCase():e===t)}function a(e,t){return e.some((e=>o(t,e)))}function l(e,t){if(null===t)return!1;if(t){if(o(t.full_name,e)||o(t.pro_name,e))return!0;if(o(t.ticker,e))return!0;if(t.aliases&&a(t.aliases,e))return!0;if(t.alternatives&&a(t.alternatives,e))return!0;if(0===e.indexOf("FRA:")&&o(t.pro_name,e.replace("FRA:","FWB:")))return!0}return!1}function d(e){return{symbol:e.symbol(),currency:e.currency(),unit:e.unit(),interval:e.interval(),style:e.style(),session:n.Interval.parse(e.interval()).isDWM()?void 0:e.sessionId()}}function h(e,t,i){
const{symbol:r,currency:o,unit:a,style:l,interval:d,session:h}=t,u=void 0!==r&&!e.symbolSameAsResolved(r);let c,_;const p=e.symbolInfo();null!==p?(c=void 0!==o&&!function(e,t){return null===e&&!(0,s.isConvertedToOtherCurrency)(t)||e===(0,s.symbolCurrency)(t)}(o,p),_=void 0!==a&&!function(e,t,i){return null===e&&!(0,s.isConvertedToOtherUnit)(t,i)||e===(0,s.symbolUnit)(t,i)}(a,p,i)):(c=void 0!==o&&o!==e.currency(),_=void 0!==a&&a!==e.unit());return{symbolChanged:u,intervalChanged:void 0!==d&&!n.Interval.isEqual(e.interval(),d),currencyChanged:c,unitChanged:_,styleChanged:void 0!==l&&l!==e.style(),sessionChanged:void 0!==h&&h!==e.sessionId(),styleChangeRequiresRestart:void 0!==l&&(0,s.styleChangeRequiresRestart)(l,e.style())}}},108024:(e,t,i)=>{i.d(t,{TimeAxisView:()=>o});var s=i(650369),n=i(436465);class r{constructor(){this._data=null}setData(e){this._data=e}draw(e,t,i){if(null===this._data||!this._data.visible||0===this._data.text.length)return;const s=this._data;e.font=i.font;const r=Math.round(i.widthCache.measureText(e,s.text));if(r<=0)return;e.save();const o=i.paddingHorizontal,a=r+2*o,l=a/2;let d=s.coordinate,h=Math.floor(d-l)+.5;if(s.alwaysInViewPort){const e=s.width;h<0?(d+=Math.abs(0-h),h=Math.floor(d-l)+.5):h+a>e&&(d-=Math.abs(e-(h+a)),h=Math.floor(d-l)+.5)}const u=h+a,c=Math.ceil(0+i.borderSize+i.offsetSize+i.paddingTop+i.fontSize+i.paddingBottom),{horizontalPixelRatio:_,verticalPixelRatio:p}=t;e.fillStyle=s.background;const g=Math.round(h*_),m=Math.round(0*p),S=Math.round(u*_),y=Math.round(c*p),v=Math.round(2*_);e.beginPath(),e.moveTo(g,m),e.lineTo(g,y-v),e.arcTo(g,y,g+v,y,v),e.lineTo(S-v,y),e.arcTo(S,y,S,y-v,v),e.lineTo(S,m),e.fill();const P=0+i.borderSize+i.offsetSize+i.paddingTop+i.fontSize/2;e.textAlign="left",e.textBaseline="middle",e.fillStyle=s.color;const f=i.widthCache.yMidCorrection(e,"Apr0");e.translate((h+o)*_,(P+f)*p),(0,n.drawScaled)(e,_,p,(()=>e.fillText(s.text,0,0))),e.restore()}}class o{constructor(e){this._renderer=new r,this._rendererData={background:"",color:"",coordinate:0,text:"",visible:!1,width:0,alwaysInViewPort:!0},this._invalidated=!0,this._model=e,this._renderer.setData(this._rendererData)}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}coordinate(){return this._rendererData.coordinate}_getAlwaysInViewPort(){return!0}_getText(e){const t=this._model.timeScale().indexToUserTime(e);return null!==t?this._model.dateTimeFormatter().format(t):""}_updateImpl(){const e=this._rendererData;if(e.visible=!1,this._model.timeScale().isEmpty()||!this._isVisible())return;const t=this._getIndex();null!==t&&Number.isFinite(t)&&(e.visible=!0,e.width=this._model.timeScale().width(),e.background=this._getBgColor(),e.color=(0,s.colorFromBackground)(e.background),e.coordinate=this._model.timeScale().indexToCoordinate(t),e.alwaysInViewPort=this._getAlwaysInViewPort(),e.text=this._getText(t),this._invalidated=!1)}}},925341:(e,t,i)=>{i.d(t,{UndoCommand:()=>n});var s=i(892323);class n{constructor(e,t=!0,i=!0){
this._text=e||new s.TranslatedString("",""),this._executeOnPush=t,this._affectsState=i}text(){return this._text}executeOnPush(){return this._executeOnPush}affectsState(){return this._affectsState}canMerge(e){return!1}merge(e){throw new Error("Should be re-implemented in child classes")}}},427060:(e,t,i)=>{i.d(t,{canPlaceAlertOnResolution:()=>r});var s=i(666310),n=i(778016);function r(e,t){const i=s.Interval.isSeconds(e),r=t?t?.alertsOnSeconds:(0,n.enabled)("ALERTS_ON_SECONDS");return!i||r}},395296:(e,t,i)=>{i.d(t,{getChartAlertsFacade:()=>o,getChartAlertsFacadeIfCreatedBefore:()=>a});var s=i(502194);let n,r;async function o(){return n||(n=async function(){const[e,{getAlertsCollection:t},n]=await Promise.all([Promise.all([i.e(32856),i.e(93523),i.e(55091),i.e(81781),i.e(43287),i.e(58229),i.e(8212),i.e(36679)]).then(i.bind(i,95958)),Promise.all([i.e(35822),i.e(55091),i.e(81781),i.e(43287),i.e(58229),i.e(14141)]).then(i.bind(i,58229)),(0,s.getChartSourceIdsGetter)()]);return new e.ChartAlertsFacade(t(),n)}()),r||(r=await n),r}function a(){return r??null}},502194:(e,t,i)=>{i.d(t,{getChartSourceIdsGetter:()=>s});const s=(0,i(481251).default)((async()=>{const{ChartSourceIdsGetter:e}=await Promise.all([i.e(62885),i.e(55091),i.e(81781),i.e(43287),i.e(58229),i.e(79979)]).then(i.bind(i,67559));return new e}))},648844:(e,t,i)=>{i.d(t,{showGoProAlertsOnSecondsDialog:()=>n});var s=i(277038);i(659863);function n(){(0,s.createGoProDialog)({feature:"alertsOnSeconds"})}}}]);