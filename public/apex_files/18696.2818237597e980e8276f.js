"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[18696],{129586:(t,e,i)=>{function s(t){return"object"==typeof t&&"metaInfo"in t}function n(t){return null==t}var r;i.d(e,{TelemetryGroup:()=>r,hasMetaInfo:()=>s,isAbsentParam:()=>n}),function(t){t.Fast="fast",t.Medium="medium",t.Slow="slow"}(r||(r={}))},603774:(t,e,i)=>{i.d(e,{logPineMetaInfoIssues:()=>o});var s=i(735566),n=i(290222);function r(t,e,i){(0,n.getPersistentLogger)()?.addPersistentLogEntry(`Detected meta info (id: ${t.id}) issue: ${e}. Source: ${i}`,s.LOGLEVEL.ERROR,"PineMetaInfoValidation")}function o(t,e){e&&e.defaults&&e.defaults.inputs&&!e.defaults.inputs.text&&r(e,'no "defaults.inputs.text" value',t),e&&e.inputs&&(e.inputs.find((t=>"text"===t.id))||r(e,'no input with id "text"',t))}},791488:(t,e,i)=>{i.d(e,{EMPTY_SOURCE_CODE:()=>u,PINE_SCRIPT_MODIFIED_LOCK:()=>l,RE_MESSAGE_LINE_WITH_DIGITS:()=>c,TV_SCRIPT_DELETED:()=>o,TV_SCRIPT_LEGACY_PINE_PROCESSED:()=>d,TV_SCRIPT_MODIFICATION_ACTIVE:()=>n,TV_SCRIPT_MODIFIED:()=>r,TV_SCRIPT_RENAMED:()=>a,pineTelemetryGroups:()=>p});var s=i(129586);const n="TVScriptModificationActive",r="TVScriptModified",o="TVScriptDeleted",a="TVScriptRenamed",d="TVScriptLegacyPineProcessed",u="Cannot save empty source code",l="pine_script_modified_lock",c=/[l|L]ines? (\d*)/,p=new Map([["delete",s.TelemetryGroup.Fast],["get",s.TelemetryGroup.Fast],["is_auth_to_get",s.TelemetryGroup.Fast],["is_auth_to_write",s.TelemetryGroup.Fast],["parse_title",s.TelemetryGroup.Fast],["rename",s.TelemetryGroup.Fast],["lib_list",s.TelemetryGroup.Fast],["list",s.TelemetryGroup.Medium],["eval_pine_ex",s.TelemetryGroup.Medium],["translate_light",s.TelemetryGroup.Medium],["process_legacy",s.TelemetryGroup.Slow],["publish",s.TelemetryGroup.Slow],["save",s.TelemetryGroup.Slow],["translate",s.TelemetryGroup.Slow],["translate_source",s.TelemetryGroup.Slow],["gen_alert",s.TelemetryGroup.Slow]])},197677:(t,e,i)=>{i.d(e,{pineFacadeFetch:()=>p});var s=i(735566),n=i(954912),r=i(881992),o=i(129586),a=i(175203),d=i(791488);const u=(0,s.getLogger)("Chart.Study.Versioning");function l(t,e){const i=new URL(function(t){return t.split("/").map((t=>encodeURIComponent(t))).join("/")}(t),(0,r.getPineFacadeUrl)());for(const t in e){const s=e[t];(0,o.isAbsentParam)(s)||i.searchParams.set(t,String(s))}return i.toString()}function c(t,e){const i={method:t,mode:"cors",credentials:"include"};return"POST"===t&&e&&(i.body=function(t){const e=new FormData;for(const i of Object.keys(t))e.append(i,t[i]);return e}(e)),i}async function p({urlPath:t,urlParams:e,data:i,method:s="GET"}){const r=l(t,e),o=c(s,i),p=function(t){u.logNormal(`Requesting pine facade scripts, url: ${t}`);const e=t.split("/")[0],i=d.pineTelemetryGroups.get(e),s=Date.now();return e=>{const n=Date.now()-s;if(a.telemetry.sendReport("pine",`${i}_group_time_frame`,{value:n}),e)return a.telemetry.sendReport("pine",`${i}_group_ok`),void u.logNormal(`Requesting pine facade scripts finished, url: ${t}`);a.telemetry.sendReport("pine",`${i}_group_error`),
u.logError(`Requesting pine facade scripts failed, url: ${t}`)}}(t);try{const t=await(0,n.fetch)(r,o);if(!t.ok)throw function(t){return t.status>=500?"Server error, try again or contact support.":413===t.status?"The size of the script compilation request is too large.":420===t.status?"Script title is too long. Max allowed length is 128 characters.":403===t.status?"To use it, ask the author to publish the script.":t.status>=400?"Request error, try again or contact support.":"Something went wrong, try again or contact support."}(t);const e=await t.json();return p(!0),e}catch(t){throw p(!1),t}}},881992:(t,e,i)=>{i.d(e,{applyGlobalScriptListeners:()=>_,getOnlyPineStudies:()=>S,getPineFacadeUrl:()=>l,getUserName:()=>u,handleResult:()=>p,handleSaveResult:()=>h,handleTranslateResult:()=>f,isPineReasonData:()=>T,onDeleteScript:()=>I,onLegacyScriptProceed:()=>y,onModifyScript:()=>g,onModifyScriptActiveChanged:()=>m,onRenameScript:()=>v});var s=i(251954),n=i(226722),r=i(971417),o=i(791488),a=i(401843),d=i(129586);function u(){return window.user&&window.user.username}function l(){const t=new URL(window.PINE_URL,location.origin);return t.pathname.endsWith("/")||(t.pathname+="/"),t.href}function c(t){if("object"==typeof t.reason)return t.reason;if(t.reason2)return t.reason2;const e={errors:[],warnings:[]};if((0,d.hasMetaInfo)(t.result)){const i=t.result&&t.result.metaInfo;i&&void 0!==i.warnings&&i.warnings.forEach((t=>e.warnings.push({message:t})))}if(t.reason){(Array.isArray(t.reason)?t.reason:t.reason.split("\n")).forEach((t=>{const i=t.match(o.RE_MESSAGE_LINE_WITH_DIGITS),s=i&&i.length&&Number(i[1]),n={message:t};if("number"==typeof s){n.start={line:s,column:0};const t=n.message.split(": ");t.shift(),n.message=t.join(": ")}e.errors.push(n)}))}return e}function p(t){if(t.success)return t.result;if(t.error)throw t.error;throw c(t)}function f(t){if(t.success)return{success:t.success,metaInfo:t.result.metaInfo,compileErrors:c(t)};throw new a.PineCompileFailErrorImpl(c(t),t.result.metaInfo)}function h(t){if(t.error)throw t.error;return{success:t.success,metaInfo:t.result.metaInfo,compileErrors:c(t)}}function m(t,e,i){const r={scriptIdPart:t,scriptVersionToUpdate:e,active:i};n.TVXWindowEvents.emit(o.TV_SCRIPT_MODIFICATION_ACTIVE,JSON.stringify(r)),s.emit(o.TV_SCRIPT_MODIFICATION_ACTIVE,r),setTimeout((async()=>{const t=await(window.scriptUpdater?.());t?.onModifyScriptActiveChanged(r)}))}function g(t,e,i,r){const a={scriptMetaInfo:t,scriptVersionToUpdate:e,compilationFailed:i,compileErrors:r};n.TVXWindowEvents.emit(o.TV_SCRIPT_MODIFIED,JSON.stringify(a)),s.emit(o.TV_SCRIPT_MODIFIED,a),window.scriptUpdater?.()?.then((t=>t.onTVScriptModified({...a,isSelfCall:!0})))}function I(t){const e={scriptIdPart:t};n.TVXWindowEvents.emit(o.TV_SCRIPT_DELETED,JSON.stringify(e)),s.emit(o.TV_SCRIPT_DELETED,e),setTimeout((async()=>{const t=await(window.scriptUpdater?.());await(t?.onTVScriptDeleted({...e,isSelfCall:!0}))}))}function v(t,e){const i={scriptIdPart:t,scriptName:e};n.TVXWindowEvents.emit(o.TV_SCRIPT_RENAMED,JSON.stringify(i)),
s.emit(o.TV_SCRIPT_RENAMED,i),setTimeout((async()=>{const t=await(window.scriptUpdater?.());t?.onTVScriptRenamed({...i,isSelfCall:!0})}))}function y(t){const e={scriptMetaInfo:t};n.TVXWindowEvents.emit(o.TV_SCRIPT_LEGACY_PINE_PROCESSED,JSON.stringify(e)),s.emit(o.TV_SCRIPT_LEGACY_PINE_PROCESSED,e),setTimeout((async()=>{const t=await(window.scriptUpdater?.());t?.onTVScriptLegacyPineProcessed(e)}))}function _(t,e,i){n.TVXWindowEvents.on(o.TV_SCRIPT_MODIFICATION_ACTIVE,(async t=>{const e=await(window.scriptUpdater?.());e?.onModifyScriptActiveChanged(JSON.parse(t))})),n.TVXWindowEvents.on(o.TV_SCRIPT_MODIFIED,(async t=>{i.clear();const e=await(window.scriptUpdater?.());e?.onTVScriptModified(JSON.parse(t))})),n.TVXWindowEvents.on(o.TV_SCRIPT_DELETED,(async s=>{t.clear(),e.clear(),i.clear();const n=await(window.scriptUpdater?.());await(n?.onTVScriptDeleted(JSON.parse(s)))})),n.TVXWindowEvents.on(o.TV_SCRIPT_RENAMED,(async t=>{i.clear();const e=await(window.scriptUpdater?.());e?.onTVScriptRenamed(JSON.parse(t))})),n.TVXWindowEvents.on(o.TV_SCRIPT_LEGACY_PINE_PROCESSED,(async t=>{i.clear();const e=await(window.scriptUpdater?.());e?.onTVScriptLegacyPineProcessed(JSON.parse(t))}))}function S(t){return t.filter((t=>{const e=(0,r.extractPineId)(t.metaInfo().id);return e&&(0,r.isCustomPineId)(e)}))}function T(t){return"object"==typeof t&&null!==t&&("errors"in t||"warnings"in t)}},401843:(t,e,i)=>{i.d(e,{PineCompileFailErrorImpl:()=>s});class s extends Error{constructor(t,e){super("Pine translation failed"),this.reason=t,this.metaInfo=e}}},427233:(t,e,i)=>{i.d(e,{RequestCache:()=>n,SingleRequestCache:()=>r});var s=i(900608);class n{constructor(){this._cache=new Map,window.loginStateChange&&window.loginStateChange.subscribe(this,this.clear)}get(t){return this._cache.get(t)}set(t,e){this._cache.set(t,e)}delete(t){return this._cache.delete(t)}clear(){this._cache.clear()}}class r extends n{constructor(){super(),this._key=(0,s.guid)()}reset(t){super.set(this._key,t)}get(){return super.get(this._key)}clear(){super.clear()}}},914417:(t,e,i)=>{i.d(e,{Version:()=>n});var s=i(650151);class n{constructor(t,e){this._major=t,this._minor=e}major(){return this._major}minor(){return this._minor}isZero(){return 0===this._major&&0===this._minor}toString(){return this._major+"."+this._minor}compareTo(t){return this._major<t._major?-1:this._major>t._major?1:this._minor<t._minor?-1:this._minor>t._minor?1:0}isLess(t){return this.compareTo(t)<0}isLessOrEqual(t){return this.compareTo(t)<=0}isEqual(t){return 0===this.compareTo(t)}isGreater(t){return this.compareTo(t)>0}isGreaterOrEqual(t){return this.compareTo(t)>=0}static parse(t){if(t instanceof n)return new n(t.major(),t.minor());if("number"==typeof t)return(0,s.assert)(Math.floor(t)===t,"Version should not be a float number"),new n(t,0);if("string"==typeof t){const e=t.split(".");if(1===e.length){const i=parseInt(e[0],10);return(0,s.assert)(!isNaN(i),"Bad version string: "+t),new n(i,0)}if(2===e.length){const i=parseInt(e[0],10);(0,s.assert)(!isNaN(i),"Bad version string: "+t)
;const r=parseInt(e[1],10);return(0,s.assert)(!isNaN(r),"Bad version string: "+t),new n(i,r)}throw new Error("Bad version string (one dot expected): "+t)}throw new Error("Bad version: "+t)}}n.ZERO=new n(0,0)},708246:(t,e,i)=>{i.d(e,{iterateAndPatchObjectsByMap:()=>f,patchPropertiesAsync:()=>p,processLegacy:()=>h});var s=i(650151),n=i(735566),r=i(290222),o=i(197188),a=i(345848),d=i(603774),u=i(282312),l=i(744404);const c=(0,n.getLogger)("Pine.ScriptLib");function p(t,e,i,s=null,o,d){return c.logNormal("patchPropertiesAsync"),d=d??void 0===o,new Promise(((p,h)=>{if(!e.TVScriptMetaInfoExprs)return void p(t);const m=e.TVScriptMetaInfoExprs.tree||"",g=e.TVScriptMetaInfoExprs.patchMap||{};(function(t,e){(0,a.trackEvent)("Pine","ScriptLib.evalMetaInfoExprs");const i=l.Deferred(),s={username:window.user&&window.user.username,source:t,inputs:JSON.stringify(e||{})};return(0,u._pineFacadeAjax)("POST","/eval_pine_ex/",s).done(((t,e)=>{t.error?i.reject((0,u._readableError)(t.error,e)):t.success?i.resolve(t.result):i.reject((0,u.safetyGetReason)(t))})).fail((t=>{(0,u._anyRequestAsyncFail)(i,t)})),i.promise()})(m,i).done((i=>{if(!i)return void p(t);if(s?.aborted)return;const a=t.childs().inputs.childs().text.value(),u=i.rootValues;f([t,e.defaults,e],g,((e,i,s)=>{const n=u[s],r=e[0],a=e[1],l=e[2];if(d||void 0!==o?.[s]&&o[s]!==n)if(a?.hasOwnProperty(i)&&l?.hasOwnProperty(i)&&c.logError(`Inconsistent meta info structure: both defaults and meta have property ${i}`),a?.hasOwnProperty(i)){const e=r[i];t.childs()?.patchMetaInfoDefaults?.value()?((d||e.value()===a[i])&&e.setValue(n),a[i]=n):e.setValue(n)}else l[i]=n})),void 0!==o&&Object.keys(u).forEach((t=>{void 0!==o[t]&&(o[t]=u[t])}));const l=t.childs().inputs.childs().text.value();a&&!l&&(0,r.getPersistentLogger)()?.addPersistentLogEntry(`Detected invalid meta info evaluation expression result: IL code input value is empty, id: ${e.fullId}`,n.LOGLEVEL.ERROR,"PineMetaInfoValidation"),p(t)})).fail((t=>{h(t)}))}))}function f(t,e,i){const n=Object.keys(e);for(let r=0;r<n.length;r++){const o=n[r],a=e[o],d=o.split(".");"defaults"===d[0]&&d.splice(0,1),(0,s.assert)(d.length>1,"Unexpectedly short json path");let u=[...t];for(let t=0;t<d.length-1;++t){const e=d[t];u=u.map((t=>t?t[e]:null))}i(u,d[d.length-1],a)}}function h(t,e){(0,a.trackEvent)("Pine","ScriptLib.processLegacy");const i=(0,o.createDeferredPromise)(),s=window.user&&window.user.username,n="/process_legacy/"+encodeURIComponent(t)+"/?user_name="+encodeURIComponent(s),r=e?{source:e}:{};return(0,u._pineFacadeAjax)("POST",n,r).done((t=>{t.error?i.reject((0,u._readableError)(t.error)):t.success?((0,d.logPineMetaInfoIssues)("ScriptLib.processLegacy",t.result.metaInfo),i.resolve(t.result.metaInfo)):i.reject((0,u.safetyGetReason)(t))})).fail((t=>{(0,u._anyRequestAsyncFail)(i,t)})),i.promise}},985324:(t,e,i)=>{i.d(e,{migrateMetaInfoAndPropState:()=>l});var s=i(650151),n=i(327734),r=i(536794)
;const o=["PennantCP@tv-basicstudies","WedgeCP@tv-basicstudies"],a=["DoubleTopCP@tv-basicstudies","BullishFlagCP@tv-basicstudies","HeadAndShouldersCP@tv-basicstudies","TripleTopCP@tv-basicstudies"];class d{targetMetaInfoVersion(){return 53}migrateMetaInfo(t){const e=t,i=t;if(i._metainfoVersion=53,void 0!==e.defaults&&void 0!==e.defaults.inputs&&(o.includes(e.id)||a.includes(e.id)&&Number(e.version)<156)){const t=e.defaults.inputs["Invert Pattern"];i.id=this._getNewIdStudies(e.id,t)}}migratePropState(t){}_getNewIdStudies(t,e){return t.startsWith("WedgeCP")?e?"WedgeFallingCP@tv-basicstudies":"WedgeRisingCP@tv-basicstudies":t.startsWith("PennantCP")?e?"PennantBearishCP@tv-basicstudies":"PennantBullishCP@tv-basicstudies":t.startsWith("DoubleTopCP")&&e?"DoubleBottomCP@tv-basicstudies":t.startsWith("BullishFlagCP")&&e?"BearishFlagCP@tv-basicstudies":t.startsWith("HeadAndShouldersCP")&&e?"HeadAndShouldersInverseCP@tv-basicstudies":t.startsWith("TripleTopCP")&&e?"TripleBottomCP@tv-basicstudies":t}}const u=[new class{targetMetaInfoVersion(){return 47}migrateMetaInfo(t){const e=t,i=t;if(i._metainfoVersion=47,!e.defaults||void 0===e.defaults.precision)return void(i.format={type:"inherit"});const s=e.defaults&&e.defaults.precision,n=(0,r.isNumber)(s)?s:parseInt(s);0===n?i.format={type:"volume"}:isFinite(n)?i.format={type:"price",precision:n}:i.format={type:"inherit"},delete e.defaults.precision}migratePropState(t){}},new class{targetMetaInfoVersion(){return 50}migrateMetaInfo(t){const e=t,i=t;if(i._metainfoVersion=50,void 0===e.defaults||void 0===e.defaults.ohlcPlots||void 0===e.ohlcPlots)return;const n=e.ohlcPlots,r=e.defaults.ohlcPlots,o=(0,s.ensureDefined)((0,s.ensureDefined)(i.defaults).ohlcPlots);for(const t of Object.keys(r)){const e=r[t];if("ohlc_candles"===e.plottype){let i=!1;const s=n[t];void 0!==s&&(i=!!s.drawBorder,delete s.drawBorder),o[t]={borderColor:"#000000",drawBorder:i,...e}}}}migratePropState(t){}},new class{targetMetaInfoVersion(){return 53}migrateMetaInfo(t){const e=t,i=t;if(i._metainfoVersion=53,void 0!==e.defaults){if(void 0!==e.defaults.ohlcPlots&&void 0!==e.ohlcPlots){const t=Object.keys(e.ohlcPlots),n=e.defaults.ohlcPlots,r=(0,s.ensureDefined)((0,s.ensureDefined)(i.defaults).ohlcPlots);for(const e of t){const t=n[e];if(void 0===t||void 0===t.visible)continue;const i=t.visible?4294967295:0;delete t.visible,r[e]={display:i,...t}}}if(void 0!==e.defaults.styles&&void 0!==e.plots){const t=e.plots.map((t=>t.id)),n=e.defaults.styles,r=(0,s.ensureDefined)((0,s.ensureDefined)(i.defaults).styles);for(const e of t){const t=n[e];if(void 0===t||void 0===t.visible)continue;const i=t.visible?4294967295:0;delete t.visible,r[e]={display:i,...t}}}}}migratePropState(t){if(t.ohlcPlots)for(const e of Object.keys(t.ohlcPlots)){const i=(0,s.ensureDefined)(t.ohlcPlots[e]);void 0!==i.visible&&(i.display=i.visible?4294967295:0,delete i.visible)}if(t.styles)for(const e of Object.keys(t.styles)){const i=(0,s.ensureDefined)(t.styles[e]);void 0!==i.visible&&(i.display=i.visible?4294967295:0,delete i.visible)}}}];function l(t,e){
const i=n.StudyMetaInfo.versionOf(t),r=t;void 0===r._serverMetaInfoVersion&&(r._serverMetaInfoVersion=i);const o=["PennantCP@tv-basicstudies","WedgeCP@tv-basicstudies"].includes(t.id);u.forEach((n=>{(i<0||i>=n.targetMetaInfoVersion())&&!o||(n.migrateMetaInfo(t),void 0!==e&&n.migratePropState(e),(0,s.assert)(t._metainfoVersion===n.targetMetaInfoVersion()))}))}u.push(new d),u.sort((function(t,e){return t.targetMetaInfoVersion()-e.targetMetaInfoVersion()}))},507025:(t,e,i)=>{const{clone:s}=i(536794);var n=i(914417).Version,r=i(735566).getLogger("Chart.StudyMigration");function o(t){this._studyId=t,this._maxToVers=n.ZERO,this._maxFromVers=n.ZERO,this._migrs=[]}o.prototype.addMigration=function(t,e,i){var s=n.parse(t),r=n.parse(e);s.isGreater(this._maxFromVers)&&(this._maxFromVers=s),r.isGreater(this._maxToVers)&&(this._maxToVers=r),this._migrs.push({fromVers:s,toVers:r,rules:i})},o.prototype.updateInputs=function(t,e,i){if(!i)return i;for(var n=s(i),o=t;o.isLess(e);){var a=this._findMigration(o);if(null==a)break;if(r.logNormal("Migrating study inputs from "+a.fromVers+" to "+a.toVers+" version, studyId: "+this._studyId+", migration: "+JSON.stringify(a)+", inputs: "+JSON.stringify(i)),n=this._applyMigration(n,a),!o.isLess(a.toVers))throw new Error("Problems in study migration process... Possible infinite cycle has been detected and stopped.");o=a.toVers}return o>t&&r.logNormal("Study inputs migration is done, studyId: "+this._studyId+", inputs: "+JSON.stringify(n)),n},o.prototype._findMigration=function(t){for(var e=-1,i=this._maxFromVers,s=0;s<this._migrs.length;s++){var n=this._migrs[s];n.fromVers.isLess(t)||n.fromVers.isLessOrEqual(i)&&(i=n.fromVers,e=s)}return e<0?null:this._migrs[e]},o.prototype._applyMigration=function(t,e){for(var i=t,s=0;s<e.rules.length;s++){var n=e.rules[s];i=this._getApplyRuleFun(n.type)(i,n)}return i},o.prototype._getApplyRuleFun=function(t){if("inputRemoved"===t)return o._applyInputRemovedRule;if("inputChangedType"===t)return o._applyInputChangedTypeRule;if("inputChangedMinMax"===t)return o._applyInputChangedMinMaxRule;if("inputChangedOptions"===t)return o._applyInputChangedOptionsRule;throw new Error("Unknown migration rule type: "+t)},o._applyInputRemovedRule=function(t,e){if(!(e.inputId in t))return t;if("removeVal"!==e.action)throw new Error("Unexpected rule.action="+e.action+" in rule.type="+e.type);var i=t[e.inputId];return delete t[e.inputId],r.logNormal("Input "+e.inputId+"="+i+" removed"),t},o._applyInputChangedTypeRule=function(t,e){var i=t[e.inputId];if("resetToDefVal"===e.action)return t[e.inputId]=e.defVal,r.logNormal("Input "+e.inputId+"="+i+" reset to default value "+e.defVal),t;if("convertVal"===e.action){if(null==i)return t;if("float"===e.inputTypeFrom&&"integer"===e.inputType)return t[e.inputId]=Math.round(t[e.inputId]),r.logNormal("Input "+e.inputId+"="+i+" converted to value "+t[e.inputId]),t;if("integer"===e.inputTypeFrom&&"float"===e.inputType)return t;if("text"===e.inputTypeFrom&&"source"===e.inputType)return o._isValidSource(i,e.options)||(t[e.inputId]=e.defVal),t
;throw new Error("Cannot convertVal from "+e.inputTypeFrom+" to "+e.inputType)}throw new Error("Unknown action "+e.action+" for rule with type "+e.type)},o._isValidSource=function(t,e){return t.indexOf("$")>=0||e.indexOf(t)>=0},o._applyInputChangedMinMaxRule=function(t,e){if("adjustValIfNeeded"!==e.action)throw new Error("Unknown action "+e.action+" for rule with type "+e.type);var i=t[e.inputId];return i<e.minVal?t[e.inputId]=e.minVal:i>e.maxVal&&(t[e.inputId]=e.maxVal),r.logNormal("Input "+e.inputId+"="+i+" adjusted to value "+t[e.inputId]),t},o._applyInputChangedOptionsRule=function(t,e){if(!(["text"].indexOf(e.inputType)>=0&&"resetToDefValIfNeeded"===e.action))throw new Error("Unexpected rule.inputType="+e.inputType+" in rule.action="+e.action);var i=t[e.inputId];return e.options.indexOf(i)<0&&(t[e.inputId]=e.defVal,r.logNormal("Input "+e.inputId+"="+i+" reset to default value "+e.defVal)),t},t.exports=o},344060:(t,e,i)=>{i.d(e,{StudyVersioning:()=>y});var s=i(998034),n=i(650151),r=i(327734),o=i(507025),a=i.n(o),d=i(735566),u=i(914417),l=i(985324),c=i(520533),p=i(444372);var f=i(708246),h=i(971417),m=i(66974),g=i(536794);const I=(0,d.getLogger)("Chart.Study.Versioning"),v=1e12;class y{constructor(t,e){if(this._migrations={},!t)throw new Error("No studies metainfo");if(this._studiesMetainfo=t,!e)throw new Error("No studies migrations");this._studiesMigrations=e;for(let t=0;t<this._studiesMigrations.length;t++){const e=this._studiesMigrations[t],i=e.versFrom,s=e.versTo;for(let t=0;t<e.studyMigrations.length;t++){const n=e.studyMigrations[t],r=n.studyId;if(0===n.rules.length){I.logError("Study Migration should have at least one convertion rule");continue}const o=r in this._migrations?this._migrations[r]:new(a())(r);o.addMigration(i,s,n.rules),this._migrations[r]=o}}this._clientMigrations=[(t,e)=>{if(0===this._studiesMetainfo.length||!t.isTVScript||t.version>=22)return e;const i={};let s=0,n=0,r=e[n];for(;void 0!==r;){const t=e[r.id];r.isFake&&(r.id="in_"+s++),i[n]=r,i[r.id]=t,n++,r=e[n]}return i}]}updateMetaInfoAsync(t,e){const i=r.StudyMetaInfo.versionOf(t);if(t.isTVScript&&!t.pine&&i<43){(0,n.assert)((0,g.isExistent)(t.scriptIdPart),"scriptIdPart is missing, study "+JSON.stringify(t));const i=t.scriptIdPart;return{sync:!1,result:new Promise(((s,n)=>{(0,f.processLegacy)(i,t.TVScriptSourceCode).then((i=>{t.removeDefaults();const n=new r.StudyMetaInfo(i);e&&n.createDefaults();const o=n.state();(0,l.migrateMetaInfoAndPropState)(o),s(new r.StudyMetaInfo(o))})).catch((t=>{n(t)}))}))}}if(t.isTVScript&&t.pine){if((t._serverMetaInfoVersion||i)<54){return{sync:!1,result:(0,c.translateScriptAsync2)(t.scriptIdPart,t.pine.version).then((i=>{t.removeDefaults();const s=new r.StudyMetaInfo(i.metaInfo);e&&s.createDefaults();const n=s.state();return(0,l.migrateMetaInfoAndPropState)(n),new r.StudyMetaInfo(n)}))}}return e&&t.createDefaults(),{sync:!0,result:t}}{let e=null;const i=this._studiesMetainfo;for(let s=0;s<i.length;s++)if(i[s].id===t.id){e=i[s];break}return{sync:!0,result:e?new r.StudyMetaInfo(e.state()):null}}}
updateStudyState(t,e,i){if(null==t||null==e||null==i)return t;t=(0,g.clone)(t),this.updateStudyInputsIfNeeded(t,e.version,i);for(const i of this._clientMigrations){const s=i.call(this,e,t.inputs);Object.keys(s).length===Object.keys(t.inputs).length?t.inputs=s:I.logWarn("StudyVersioning._clientMigrations application returned bad result. Skipping it...")}const s=r.StudyMetaInfo.versionOf(e);if(e.isTVScript&&e.TVScriptSourceCode&&s>=12&&s<=26){const s={};for(let t=0;t<e.plots.length;++t){const n=e.plots[t],r=i.plots[t];s[n.id]=r.id}const n=Object.keys(t.styles);for(let e=0;e<n.length;++e){const i=n[e],r=t.styles[i];delete t.styles[i];const o=s[i];t.styles[o]=r}const r=Object.keys(t.plots);for(let e=0;e<r.length;++e){const i=r[e],n=t.plots[i].id;t.plots[i].id=s[n]}}return t}updateStudyInputsIfNeeded(t,e,i){if(!(i.isTVScript||!!i.pine)&&e!==i.version){const s=i&&i.defaults.inputs;t.inputs=this.updateStudyInputs(i.id,e,i.version,t.inputs,s)}}updateStudyInputs(t,e,i,s,n){let r=(0,g.clone)(s);if(t in this._migrations){const s=u.Version.parse(e);let n;if("last"===i){const e=this.lastVersionOfStudy(t);n=u.Version.parse(e)}else n=u.Version.parse(i);r=this._migrations[t].updateInputs(s,n,r)}if(null==n)return r;for(const t in n)t in r||(r[t]=n[t]);for(const i in r)if(!(i in n)){const s=r[i];I.logWarn(`Extra input detected, studyId='${t}', versionFrom='${e}', inputId='${i}', inputValue='${s}', removing it and continue...`),delete r[i]}return r}lastVersionOfStudy(t){return(0,n.ensureDefined)(this._studiesMetainfo.find((e=>e.id===t))).version}updateMetaInfo(t){if(!t)return t;(0,n.assert)(t instanceof r.StudyMetaInfo),(0,n.assert)(!t.isTVScript,"This method should update only built-in java indicators metaInfo. For Pine indicators use updateMetaInfoAsync");const e=this._studiesMetainfo.find((e=>t.id===e.id));return e?new r.StudyMetaInfo(e.state()):null}static patchPointsBasedStudyState(t){return this._fixInputsMaxValue(t.state,t.metaInfo),"LineToolRegressionTrend"===t.type&&(t=function(t){const e={palettes:{},inputs:[{defval:2,id:"upper diviation",max:500,min:-500,name:p.t(null,void 0,i(591900)),type:"integer"},{defval:-2,id:"lower diviation",max:500,min:-500,name:p.t(null,void 0,i(831736)),type:"integer"},{defval:!0,id:"use upper diviation",name:p.t(null,void 0,i(784451)),type:"bool"},{defval:!0,id:"use lower diviation",name:p.t(null,void 0,i(449299)),type:"bool"},{defval:0,id:"first bar time",max:253370764800,min:0,name:p.t(null,void 0,i(780509)),type:"time"},{defval:0,id:"last bar time",max:253370764800,min:0,name:p.t(null,void 0,i(59933)),type:"time"},{defval:"close",id:"source",name:p.t(null,void 0,i(997751)),options:["open","high","low","close","hl2","hlc3","ohlc4"],type:"text"}],plots:[],graphics:{},defaults:{inputs:{"first bar time":0,"last bar time":0,"lower diviation":-2,source:"close","upper diviation":2,"use lower diviation":!0,"use upper diviation":!0}},_metainfoVersion:6,description:"Regression Trend",id:"RegressionTrend@tv-basicstudies",is_price_study:!0,shortDescription:"Reg Trend",shortId:"RegressionTrend",
version:"2",fullId:"RegressionTrend@tv-basicstudies-2",name:"RegressionTrend@tv-basicstudies"};return t.metaInfo||(t.metaInfo=e),t}(t)),t}static patchStudyData(t,e,i,s){if(!(0,m.isProd)())return{data:e,nsData:i,indexes:s??void 0};const n=(0,g.clone)(e),o=(0,g.clone)(i),a=(0,g.clone)(s);"VbPVisible@tv-volumebyprice"===t.id&&t.version&&+t.version<=4&&this._patchOldVolumeProfiles(0,n?.graphics),"VbPSessions@tv-volumebyprice"===t.id&&t.version&&+t.version<=4&&this._patchOldVolumeProfiles(0,n?.graphics);const d=r.StudyMetaInfo.versionOf(t);if(n&&t.isTVScript&&t.TVScriptSourceCode&&d>=12&&d<=26){const t=n.columns,e=[];n.columns=e;for(let i=0;i<t.length;++i){const t="plot_"+i;e.push(t)}}return{data:n,nsData:o,indexes:a??void 0}}static patchPointsBasedStudyData(t,e){if(!(0,m.isProd)())return e;if(!t||!e)return e;const i=(0,g.clone)(e);return"VbPFixed@tv-volumebyprice"===t.id&&t.version&&+t.version<=4&&this._patchOldVolumeProfiles(0,i),i}static patchPropsStateAndMetaInfo(t,e,i){let n=e.state();"Script$BOOKER"!==e.productId||n.alerts||delete t.alerts,this._fixInputsOrder(t,n),this._fixInputsMaxValue(t,n);const o=this.splitInputs(t.inputs);t.inputs=o.obj;const a=r.StudyMetaInfo.versionOf(e);a<42&&n.isChildStudy&&(t.isChildStudy=n.isChildStudy);if(e.isTVScript&&e.version<60&&("Script$TV_EARNINGS@tv-scripting"!==e.id&&"Script$TV_DIVIDENDS@tv-scripting"!==e.id&&"Script$TV_SPLITS@tv-scripting"!==e.id||delete n.TVScriptSourceCode),"Volume"!==e.id&&"Volume@tv-basicstudies"!==e.id||0!==e.inputs.length||(n.inputs=[{id:"length",type:"integer",defval:20,min:1,max:1e3}],n.plots.push({id:"vol_ma",type:"line"})),"Volume@tv-basicstudies"===e.id&&e.version&&e.version<=46&&void 0===t.styles.vol.transparency&&(t.styles.vol.transparency=t.transparency||87),"PivotPointsStandard@tv-basicstudies"===e.id&&(0===n.inputs.length?(t.inputs={kind:"Traditional",showHistoricalPivots:!0},n.inputs=[{defval:"Traditional",id:"kind",type:"text",options:["Traditional","Fibonacci","Woodie","Classic","DeMark","Camarilla"]},{id:"showHistoricalPivots",type:"bool",defval:!0}]):1===n.inputs.length&&(t.inputs={kind:"Traditional"},n.inputs=[{defval:"Traditional",id:"kind",type:"text",options:["Traditional","Fibonacci","Woodie","Classic","DeMark","Camarilla"]},{id:"showHistoricalPivots",type:"bool",defval:!0}]),void 0===t._hardCodedDefaultsVersion)){t._hardCodedDefaultsVersion=1;const e=t.color;delete t.color,t.levelsStyle={colors:{P:e,"S1/R1":e,"S2/R2":e,"S3/R3":e,"S4/R4":e,"S5/R5":e}}}"CMF"===e.shortId&&2===n.inputs.length&&(t.inputs={length:t.inputs["length fast"]},n.inputs=n.inputs.splice(0,1),n.inputs[0].id="length"),n.defaults&&void 0===n.defaults.precision&&a<46&&(-1!==["Volume@tv-basicstudies","VbPVisible@tv-volumebyprice","VbPSessions@tv-volumebyprice"].indexOf(e.id)?n.defaults.precision=0:n.defaults.precision=4);let d=e.id;if(e.version<60){const t=["TV_DIVIDENDS","TV_SPLITS","TV_EARNINGS"],i=6;for(let s=0;s<t.length;s++)e.id.startsWith("Script$"+t[s]+"@tv-scripting")&&(n.fullId="ESD"+n.fullId.substring(i),n.id="ESD"+n.id.substring(i),
n.name&&(n.name="ESD"+n.name.substring(i)),n.shortId="ESD"+n.shortId.substring(i),n.productId="ESD"+n.productId.substring(i),d="ESD"+e.id.substring(i))}const u={"ESD$TV_EARNINGS@tv-scripting":{fullId:"Earnings@tv-basicstudies-129!",id:"Earnings@tv-basicstudies",name:"Earnings@tv-basicstudies",shortId:"Earnings",productId:"tv-basicstudies"},"ESD$TV_SPLITS@tv-scripting":{fullId:"Splits@tv-basicstudies-129!",id:"Splits@tv-basicstudies",name:"Splits@tv-basicstudies",shortId:"Splits",productId:"tv-basicstudies"},"ESD$TV_DIVIDENDS@tv-scripting":{fullId:"Dividends@tv-basicstudies-129!",id:"Dividends@tv-basicstudies",name:"Dividends@tv-basicstudies",shortId:"Dividends",productId:"tv-basicstudies"}};if(d in u&&Object.assign(n,u[d]),a<43){const i={"StrategyScript$STD;Consecutive%1Ups/Downs%1Strategy":{pineId:"STD;Consecutive%1Ups%1Downs%1Strategy",className:"StrategyScript"},Script$EDGR_NET_INCOME_FROM_CONTINUING_OPERATIONS_APPLICABLE_TO_COMMON_V2:{pineId:"Script$EDGR_NET_INCOME_FROM_CONTINUING_OPS_APPLICABLE_TO_COMMON_V2",className:"Script"}};if(e.shortId in i){const r=i[e.shortId].className+"$"+i[e.shortId].pineId,o={scriptIdPart:i[e.shortId].pineId,fullId:n.fullId.replace(n.shortId,r),id:n.id.replace(n.shortId,r),name:n.name?.replace(n.shortId,r),shortId:r};(0,s.default)(n,o),(0,s.default)(t,o)}const r=(0,h.extractPineId)(e.fullId),o=r&&r.match(/^(USER)(_\d+)(;)(.*)$/);if(o){const e=o[0],i=o[1]+o[3]+o[2]+o[4],r={scriptIdPart:i,fullId:n.fullId.replace(e,i),id:n.id.replace(e,i),name:n.name?.replace(e,i),shortId:n.shortId.replace(e,i)};(0,s.default)(n,r),(0,s.default)(t,r)}}if("MA"===e.id){const e={id:"MAExp",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgExp",type:"line"}],palettes:{}},i={id:"MASimple",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgSimple",type:"line"}],palettes:{}},s={id:"MAVolumeWeighted",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgVolumeWeighted",type:"line"}],palettes:{}},r={id:"MAWeighted",properties:[{id:"is_price_study",type:"bool",value:"true"}],inputs:[{id:"length",type:"integer",defval:20,min:1,max:500},{id:"source",type:"text",defval:"close",options:["open","high","low","close"]}],plots:[{id:"MovAvgWeighted",type:"line"}],palettes:{}};switch(t.inputs.type){case"exp":n=e;break;case"simple":n=i;break;case"weighted":n=r;break;case"volume weighted":n=s}t.styles[n.plots[0].id]=t.styles.MovAvg,delete t.styles.MovAvg,delete t.inputs.type}return i.oldShowStudyLastValueProperty&&(t.oldShowLastValue=t.showLastValue),delete t.showLastValue,delete t.showStudyArguments,(0,
l.migrateMetaInfoAndPropState)(n,t),{propsState:t,metaInfo:n}}static splitInputs(t){const e={},i={};for(const[s,n]of Object.entries(t))(0,g.isNumber)(parseInt(s,10))?e[s]=n:i[s]=n;return{arr:e,obj:i}}static verifyInputsMaxValue(t){if(t.inputs)for(const e of t.inputs)"integer"===e.type&&e.max&&e.max>v&&I.logWarn("Bad integer input max value in metaInfo id="+t.id+" title="+t.description)}static mergeInputsObjPart(t,e){const i=this.splitInputs(e);(0,s.default)(t,i.obj)}static _fixInputsOrder(t,e){const i=this._getOrderedInputIds(e),n=this.splitInputs(t.inputs),r=n.arr,o=n.obj,a=(0,s.default)({},o);for(let t=0;t<i.length;++t){const e=i[t],s=this._findInputKeyById(r,e);null!==s&&(a[t]=r[s])}t.inputs=a}static _fixInputsMaxValue(t,e){if((0,g.isAbsent)(e))return;const i=v;if(e.inputs)for(const t of e.inputs)"integer"===t.type&&t.max&&t.max>i&&(t.max=i);if(!t||!t.inputs)return;const n=this.splitInputs(t.inputs),r=n.arr;for(const[,t]of Object.entries(r))"integer"===t.type&&t.max&&t.max>i&&(t.max=i);t.inputs=(0,s.default)(n.obj,n.arr)}static _findInputKeyById(t,e){let i=null;for(const s in t)if((0,g.isNumber)(parseInt(s,10))&&t[s].id===e){i=s;break}return i}static _getOrderedInputIds(t){const e=[];for(const i of t.inputs)e.push(i.id);return e}static _patchOldVolumeProfiles(t,e){if(!e?.hhists)return;const i=e.hhists[t].data,s=[];for(const[,t]of Object.entries(i))s.push(t);e.hhists[0].data=s}}}}]);